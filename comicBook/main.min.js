var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__awaiter=this&&this.__awaiter||function(t,e,i,o){return new(i||(i=Promise))(function(n,s){function r(t){try{h(o.next(t))}catch(e){s(e)}}function a(t){try{h(o["throw"](t))}catch(e){s(e)}}function h(t){t.done?n(t.value):new i(function(e){e(t.value)}).then(r,a)}h((o=o.apply(t,e||[])).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return o([t,e])}}function o(i){if(n)throw new TypeError("Generator is already executing.");for(;h;)try{if(n=1,s&&(r=s[2&i[0]?"return":i[0]?"throw":"next"])&&!(r=r.call(s,i[1])).done)return r;switch(s=0,r&&(i=[0,r.value]),i[0]){case 0:case 1:r=i;break;case 4:return h.label++,{value:i[1],done:!1};case 5:h.label++,s=i[1],i=[0];continue;case 7:i=h.ops.pop(),h.trys.pop();continue;default:if(r=h.trys,!(r=r.length>0&&r[r.length-1])&&(6===i[0]||2===i[0])){h=0;continue}if(3===i[0]&&(!r||i[1]>r[0]&&i[1]<r[3])){h.label=i[1];break}if(6===i[0]&&h.label<r[1]){h.label=r[1],r=i;break}if(r&&h.label<r[2]){h.label=r[2],h.ops.push(i);break}r[2]&&h.ops.pop(),h.trys.pop();continue}i=e.call(t,h)}catch(o){i=[6,o],s=0}finally{n=r=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var n,s,r,a,h={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return a={next:i(0),"throw":i(1),"return":i(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a},__extends=this&&this.__extends||function(){var t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)e.hasOwnProperty(i)&&(t[i]=e[i])};return function(e,i){function o(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(o.prototype=i.prototype,new o)}}(),__decorate=this&&this.__decorate||function(t,e,i,o){var n,s=arguments.length,r=3>s?e:null===o?o=Object.getOwnPropertyDescriptor(e,i):o;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(t,e,i,o);else for(var a=t.length-1;a>=0;a--)(n=t[a])&&(r=(3>s?n(r):s>3?n(e,i,r):n(e,i))||r);return s>3&&r&&Object.defineProperty(e,i,r),r},ComicResourceManager=function(){function t(){this._dbConfigMap={}}return Object.defineProperty(t,"instance",{get:function(){return null==t._instance&&(t._instance=new t),t._instance},enumerable:!0,configurable:!0}),t.prototype.initConfig=function(t,e){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return null!=this._config?[3,2]:[4,RES.loadGroup("config")];case 1:e.sent(),t=RES.getRes("resource_config_json"),this._config=t,this._movieConfig=RES.getRes("comicMovieConfig_json"),this._movieVO=new ComicMovieVO(this._movieConfig),e.label=2;case 2:return this.init(),[2]}})})},Object.defineProperty(t.prototype,"movieVO",{get:function(){return this._movieVO},enumerable:!0,configurable:!0}),t.prototype.init=function(){},t.prototype.loadRoleAsset=function(t,e,i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return this._loadRoleComplete?[3,4]:[4,RES.loadGroup("role")];case 1:return t.sent(),[4,RES.loadGroup("shot")];case 2:return t.sent(),[4,RES.loadGroup("cloth")];case 3:t.sent(),this._loadRoleComplete=!0,t.label=4;case 4:return[2]}})})},t.prototype.loadDBConfig=function(t,e){null==this._dbConfigMap[e.name]&&(t.parseDragonBonesData(RES.getRes(e.dbData)).autoSearch=!0,t.parseTextureAtlasData(RES.getRes(e.textureData),RES.getRes(e.texturePng)).autoSearch=!0,this._dbConfigMap[e.name]=!0)},t.prototype.getDragonBonesAsset=function(t){var e,i,o;for(e=0,i=this._config.dbs.length;i>e;e++)if(o=this._config.dbs[e],o.name==t)return o.asset;return null},t.prototype.getArmatureAsset=function(t){var e,i,o,n,s;for(e=0,i=this._config.dbs.length;i>e;e++)for(s=this._config.dbs[e],o=0,n=s.armatures.length;n>o;o++)if(s.armatures[o]==t)return s.asset;return null},t.prototype.getSuit=function(t){var e,i;for(e=0,i=this._config.suits.length;i>e;e++)if(this._config.suits[e].name==t)return this._config.suits[e];return null},t.prototype.getCloth=function(t){var e,i;for(e=0,i=this._config.clothes.length;i>e;e++)if(this._config.clothes[e].name==t)return this._config.clothes[e];return null},t}();__reflect(ComicResourceManager.prototype,"ComicResourceManager");var LoadingUI=function(t){function e(){var e=t.call(this)||this;return e.createView(),e}return __extends(e,t),e.prototype.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},e.prototype.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);__reflect(LoadingUI.prototype,"LoadingUI");var MainPanel=function(){function t(){this._view=fairygui.UIPackage.createObject("Basic","Main").asCom,this._view.setSize(fairygui.GRoot.inst.width,fairygui.GRoot.inst.height),fairygui.GRoot.inst.addChild(this._view),this._backBtn=this._view.getChild("btn_Back"),this._backBtn.visible=!1,this._backBtn.addClickListener(this.onClickBack,this),this._demoContainer=this._view.getChild("container").asCom,this._cc=this._view.getController("c1");for(var t=this._view.numChildren,e=0;t>e;e++){var i=this._view.getChildAt(e);null!=i.group&&"btns"==i.group.name&&i.addClickListener(this.runDemo,this)}this._demoObjects={}}return t.prototype.runDemo=function(t){var e=t.currentTarget.name.substr(4),i=this._demoObjects[e];switch(null==i&&(i=fairygui.UIPackage.createObject("Basic","Demo_"+e).asCom,this._demoObjects[e]=i),this._demoContainer.removeChildren(),this._demoContainer.addChild(i),this._cc.selectedIndex=1,this._backBtn.visible=!0,e){case"Button":this.playButton();break;case"Text":this.playText();break;case"Window":this.playWindow();break;case"Popup":this.playPopup();break;case"Drag&Drop":this.playDragDrop();break;case"Depth":this.playDepth();break;case"Grid":this.playGrid()}},t.prototype.onClickBack=function(t){this._cc.selectedIndex=0,this._backBtn.visible=!1},t.prototype.playButton=function(){var t=this._demoObjects.Button;t.getChild("n34").addClickListener(this.__clickButton,this)},t.prototype.__clickButton=function(t){console.log("click button")},t.prototype.playText=function(){var t=this._demoObjects.Text;t.getChild("n12").asRichTextField.addEventListener(egret.TextEvent.LINK,this.__clickLink,this),t.getChild("n22").addClickListener(this.__clickGetInput,this)},t.prototype.__clickLink=function(t){var e=t.currentTarget;e.text="[img]ui://9leh0eyft9fj5f[/img][color=#FF0000]你点击了链接[/color]："+t.text},t.prototype.__clickGetInput=function(t){var e=this._demoObjects.Text;e.getChild("n21").text=e.getChild("n18").text},t.prototype.playWindow=function(){var t=this._demoObjects.Window;t.getChild("n0").addClickListener(this.__clickWindowA,this),t.getChild("n1").addClickListener(this.__clickWindowB,this)},t.prototype.__clickWindowA=function(t){null==this._winA&&(this._winA=new WindowA),this._winA.show()},t.prototype.__clickWindowB=function(t){null==this._winB&&(this._winB=new WindowB),this._winB.show()},t.prototype.playPopup=function(){null==this._pm&&(this._pm=new fairygui.PopupMenu,this._pm.addItem("Item 1"),this._pm.addItem("Item 2"),this._pm.addItem("Item 3"),this._pm.addItem("Item 4"),null==this._popupCom&&(this._popupCom=fairygui.UIPackage.createObject("Basic","Component12").asCom,this._popupCom.center()));var t=this._demoObjects.Popup,e=t.getChild("n0");e.addClickListener(this.__clickPopup1,this);var i=t.getChild("n2");i.addClickListener(this.__clickPopup2,this)},t.prototype.__clickPopup1=function(t){var e=t.currentTarget;this._pm.show(e,!0)},t.prototype.__clickPopup2=function(t){fairygui.GRoot.inst.showPopup(this._popupCom)},t.prototype.playDragDrop=function(){var t=this._demoObjects["Drag&Drop"],e=t.getChild("a");e.draggable=!0;var i=t.getChild("b").asButton;i.draggable=!0,i.addEventListener(fairygui.DragEvent.DRAG_START,this.__onDragStart,this);var o=t.getChild("c").asButton;o.icon=null,o.addEventListener(fairygui.DropEvent.DROP,this.__onDrop,this);var n=t.getChild("d");n.draggable=!0;var s=t.getChild("bounds"),r=new egret.Rectangle;s.localToGlobalRect(0,0,s.width,s.height,r),fairygui.GRoot.inst.globalToLocalRect(r.x,r.y,r.width,r.height,r),r.x-=t.parent.x,n.dragBounds=r},t.prototype.__onDragStart=function(t){t.preventDefault();var e=t.currentTarget;fairygui.DragDropManager.inst.startDrag(e,e.icon,e.icon)},t.prototype.__onDrop=function(t){var e=t.currentTarget;e.icon=t.source},t.prototype.playDepth=function(){var t=this._demoObjects.Depth,e=t.getChild("n22").asCom,i=e.getChild("n0");i.sortingOrder=100,i.draggable=!0;for(var o=e.numChildren,n=0;o>n;){var s=e.getChildAt(n);s!=i?(e.removeChildAt(n),o--):n++}var r=new egret.Point(i.x,i.y);t.getChild("btn0").addClickListener(function(){var e=new fairygui.GGraph;r.x+=10,r.y+=10,e.setXY(r.x,r.y),e.setSize(150,150),e.drawRect(1,0,1,16711680,1),t.getChild("n22").asCom.addChild(e)},this),t.getChild("btn1").addClickListener(function(){var e=new fairygui.GGraph;r.x+=10,r.y+=10,e.setXY(r.x,r.y),e.setSize(150,150),e.drawRect(1,0,1,65280,1),e.sortingOrder=200,t.getChild("n22").asCom.addChild(e)},this)},t.prototype.playGrid=function(){var t=this._demoObjects.Grid,e=t.getChild("list1").asList;e.removeChildrenToPool();for(var i=["苹果手机操作系统","安卓手机操作系统","微软手机操作系统","微软桌面操作系统","苹果桌面操作系统","未知操作系统"],o=[16776960,16711680,16777215,255],n=i.length,s=0;n>s;s++){var r=e.addItemFromPool().asButton;r.getChild("t0").text=""+(s+1),r.getChild("t1").text=i[s],r.getChild("t2").asTextField.color=o[Math.floor(4*Math.random())],r.getChild("star").asProgress.value=(Math.floor(3*Math.random())+1)/3*100}var a=t.getChild("list2").asList;a.removeChildrenToPool();for(var s=0;n>s;s++){var r=a.addItemFromPool().asButton;r.getChild("cb").asButton.selected=!1,r.getChild("t1").text=i[s],r.getChild("mc").asMovieClip.playing=s%2==0,r.getChild("t3").text=""+Math.floor(1e4*Math.random())}},t}();__reflect(MainPanel.prototype,"MainPanel");var WindowA=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.onInit=function(){this.contentPane=fairygui.UIPackage.createObject("Basic","WindowA").asCom,this.center()},e.prototype.onShown=function(){var t=this.contentPane.getChild("n6").asList;t.removeChildrenToPool();for(var e=0;6>e;e++){var i=t.addItemFromPool().asButton;i.title=""+e,i.icon=fairygui.UIPackage.getItemURL("Basic","r4")}},e}(fairygui.Window);__reflect(WindowA.prototype,"WindowA");var WindowB=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.onInit=function(){this.contentPane=fairygui.UIPackage.createObject("Basic","WindowB").asCom,this.center(),this.setPivot(.5,.5)},e.prototype.doShowAnimation=function(){this.setScale(.1,.1),egret.Tween.get(this).to({scaleX:1,scaleY:1},300,egret.Ease.quadOut).call(this.onShown,this)},e.prototype.doHideAnimation=function(){egret.Tween.get(this).to({scaleX:.1,scaleY:.1},300,egret.Ease.quadOut).call(this.hideImmediately,this)},e.prototype.onShown=function(){this.contentPane.getTransition("t1").play()},e.prototype.onHide=function(){this.contentPane.getTransition("t1").stop()},e}(fairygui.Window);__reflect(WindowB.prototype,"WindowB");var EVENT={SHOT_COMPLETE:"SHOT_COMPLETE",PLAY_NEXT_SHOT:"PLAY_NEXT_SHOT",MOVIE_COMPLETE:"MOVIE_COMPLETE",DIALOG_OVER:"DIALOG_OVER",DIALOG_SELECT:"DIALOG_SELECT"},ComicMovieVO=function(){function t(t){this.scenes=[],this._config=t,this.init()}return t.prototype.init=function(){var t,e;for(t=0,e=this._config.scene.length;e>t;t++){var i=new ComicSceneVO(this._config.scene[t]);this.scenes.push(i)}},Object.defineProperty(t.prototype,"startShot",{get:function(){return this.scenes[0].shots[0]},enumerable:!0,configurable:!0}),t}();__reflect(ComicMovieVO.prototype,"ComicMovieVO");var Main=function(t){function e(){var e=t.call(this)||this;return e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(t){egret.lifecycle.addLifecycleListener(function(t){t.onUpdate=function(){}}),egret.lifecycle.onPause=function(){egret.ticker.pause()},egret.lifecycle.onResume=function(){egret.ticker.resume()},this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},e.prototype.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},e.prototype.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.createGameScene2())},e.prototype.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},e.prototype.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},e.prototype.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},e.prototype.createGameScene2=function(){fairygui.UIPackage.addPackage("basic"),fairygui.UIPackage.addPackage("ui"),fairygui.UIConfig.defaultFont="宋体",fairygui.UIConfig.verticalScrollBar=fairygui.UIPackage.getItemURL("Basic","ScrollBar_VT"),fairygui.UIConfig.horizontalScrollBar=fairygui.UIPackage.getItemURL("Basic","ScrollBar_HZ"),fairygui.UIConfig.popupMenu=fairygui.UIPackage.getItemURL("Basic","PopupMenu"),fairygui.UIConfig.buttonSound=fairygui.UIPackage.getItemURL("Basic","click"),this.stage.addChild(fairygui.GRoot.inst.displayObject);var t=new ComicMovie;t.x=this.stage.stageWidth/2,t.y=this.stage.stageHeight/2,this.addChild(t)},e.prototype.createGameScene=function(){var t=this.createBitmapByName("bg_jpg");this.addChild(t);var e=this.stage.stageWidth,i=this.stage.stageHeight;t.width=e,t.height=i;var o=new egret.Shape;o.graphics.beginFill(0,.5),o.graphics.drawRect(0,0,e,172),o.graphics.endFill(),o.y=33,this.addChild(o);var n=this.createBitmapByName("egret_icon_png");this.addChild(n),n.x=26,n.y=33;var s=new egret.Shape;s.graphics.lineStyle(2,16777215),s.graphics.moveTo(0,0),s.graphics.lineTo(0,117),s.graphics.endFill(),s.x=172,s.y=61,this.addChild(s);var r=new egret.TextField;r.textColor=16777215,r.width=e-172,r.textAlign="center",r.text="Hello Egret",r.size=24,r.x=172,r.y=80,this.addChild(r);var a=new egret.TextField;this.addChild(a),a.alpha=0,a.width=e-172,a.textAlign=egret.HorizontalAlign.CENTER,a.size=24,a.textColor=16777215,a.x=172,a.y=135,this.textfield=a,RES.getResAsync("description_json",this.startAnimation,this)},e.prototype.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},e.prototype.startAnimation=function(t){var e=this,i=new egret.HtmlTextParser,o=t.map(function(t){return i.parse(t)}),n=this.textfield,s=-1,r=function(){s++,s>=o.length&&(s=0);var t=o[s];n.textFlow=t;var i=egret.Tween.get(n);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(r,e)};r()},e=__decorate([RES.mapConfig("config.json",function(){return"resource"},function(t){var e=t.substr(t.lastIndexOf(".")+1),i={jpg:"image",png:"image",webp:"image",json:"json",fnt:"font",pvr:"pvr",mp3:"sound"},o=i[e];return"json"==o&&(t.indexOf("sheet")>=0?o="sheet":t.indexOf("movieclip")>=0&&(o="movieclip")),o})],e)}(egret.DisplayObjectContainer);__reflect(Main.prototype,"Main");var ComicRoleVO=function(){function t(t){this._config=t,this.init()}return t.prototype.init=function(){this.name=this._config.name,this.asset=ComicResourceManager.instance.getArmatureAsset(this._config.role),this.suit=ComicResourceManager.instance.getSuit(this._config.suit)},Object.defineProperty(t.prototype,"clothes",{get:function(){var t=[];if(this.suit&&this.suit.clothes&&this.suit.clothes.length>0){var e=void 0,i=void 0;for(e=0,i=this.suit.clothes.length;i>e;e++){var o=ComicResourceManager.instance.getCloth(this.suit.clothes[e]);o&&t.push(o)}}return t},enumerable:!0,configurable:!0}),t}();__reflect(ComicRoleVO.prototype,"ComicRoleVO");var ComicSceneVO=function(){function t(t){this._config=t,this.init()}return t.prototype.toString=function(){return this._config.name},t.prototype.init=function(){this.roles=[],this.shots=[],this.asset=ComicResourceManager.instance.getArmatureAsset(this._config.name),this.dbData=this.asset.dbData,this.textureData=this.asset.textureData,this.texturePng=this.asset.texturePng;var t,e;for(t=0,e=this._config.roles.length;e>t;t++){var i=new ComicRoleVO(this._config.roles[t]);this.roles.push(i)}for(t=0,e=this._config.shots.length;e>t;t++){var o=new ComicShotVO(this._config.shots[t]);o.scene=this,this.shots.push(o)}this.initShots()},Object.defineProperty(t.prototype,"name",{get:function(){return this._config.name},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"startShot",{get:function(){return this.shots[0]},enumerable:!0,configurable:!0}),t.prototype.initShots=function(){var t,e;for(t=0,e=this.shots.length;e>t;t++)if(this.shots[t].next)this.shots[t].nextShots=[this.getShot(this.shots[t].next)];else if(this.shots[t].selectNext&&this.shots[t].selectNext.length>0){this.shots[t].nextShots=[];for(var i=0,o=this.shots[t].selectNext.length;o>i;i++){var n=this.getShot(this.shots[t].selectNext[i]);n&&this.shots[t].nextShots.push(n)}}},t.prototype.getShot=function(t){var e,i;for(e=0,i=this.shots.length;i>e;e++)if(this.shots[e].name==t)return this.shots[e];return null},t.prototype.getRoleAssets=function(){var t,e,i=[];for(t=0,e=this.roles.length;e>t;t++){var o=this.roles[t].asset;-1==i.indexOf(o)&&i.push(o)}return i},t.prototype.getClothAssets=function(){var t,e,i=[],o=[];for(t=0,e=this.roles.length;e>t;t++){var n=this.roles[t];if(n.suit){var s=void 0,r=void 0;for(s=0,r=n.suit.clothes.length;r>s;s++){var a=n.suit.clothes[s],h=ComicResourceManager.instance.getCloth(a);h&&-1==o.indexOf(h.data)&&o.push(h.data)}}}if(o.length>0)for(t=0,e=o.length;e>t;t++){var c=ComicResourceManager.instance.getDragonBonesAsset(o[t]);c&&i.push(c)}return i},t}();__reflect(ComicSceneVO.prototype,"ComicSceneVO");var ComicShotVO=function(){function t(t){this.dialogComplete=!1,this.playComplete=!1,this.saying=!1,this.selectIndex=-1,this._config=t,this.name=t.name,this.next=t.next,this.selectNext=t.selectNext,this.type=t.type,this.skipEnable=t.skipEnable,this.autoPlay=t.autoPlay}return Object.defineProperty(t.prototype,"nextShot",{get:function(){switch(this.type){case t.TYPE_ANIM:case t.TYPE_DIALOG:if(this.nextShots&&this.nextShots.length>0)return this.nextShots[0];break;case t.TYPE_SELECT:if(this.nextShots&&this.nextShots.length>0&&this.selectIndex>=0)return this.nextShots[this.selectIndex]}return null},enumerable:!0,configurable:!0}),t.prototype.clear=function(){this.dialogComplete=!1,this.playComplete=!1,this.saying=!1},t.TYPE_ANIM="anim",t.TYPE_DIALOG="dialog",t.TYPE_SELECT="select",t}();__reflect(ComicShotVO.prototype,"ComicShotVO");var ComicMovie=function(t){function e(){var e=t.call(this)||this;return e._sceneCache={},e.init(),e}return __extends(e,t),e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.initConfig()];case 1:return t.sent(),this.initUI(),this.play(),[2]}})})},e.prototype.initUI=function(){var t=this;this._dia=new Dialog,this._selectDia=new SelectDialog,fairygui.GRoot.inst.addChild(this._dia),fairygui.GRoot.inst.addChild(this._selectDia),this._dia.hide(),this._selectDia.hide(),this._selectDia.scaleX=this._selectDia.scaleY=1.8,this.stage&&(this._dia.view.width=this.stage.stageWidth-5,this._dia.view.height=200,this._dia.y=this.stage.stageHeight-200,this._selectDia.stageWidth=this.stage.stageWidth,this._selectDia.stageHeight=this.stage.stageHeight),this.addEventListener(egret.Event.ADDED_TO_STAGE,function(){t._dia.view.width=t.stage.stageWidth-5,t._dia.view.height=200,t._dia.y=t.stage.stageHeight-200},this)},e.prototype.initConfig=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,ComicResourceManager.instance.initConfig("config","resource_config_json")];case 1:return t.sent(),this._movieVO=ComicResourceManager.instance.movieVO,[2]}})})},e.prototype.play=function(){var t=this._movieVO.startShot;this.playShot(t)},e.prototype.playNextShot=function(t){this._currentShotVO&&this._currentShotVO.nextShot&&this.playShot(this._currentShotVO.nextShot)},e.prototype.playShot=function(t){var e=t.scene;if(console.log("play,",t.name),this._currentSceneVO==e)this._currentScene.delayPlayShot(t);else{var i=this.getScene(e);this._currentScene&&(this._currentScene.stop(),this.removeChild(this._currentScene)),this._currentScene=i,this.addChild(this._currentScene),this._currentSceneVO=e,this._currentScene.delayPlayShot(t)}this._currentShotVO=t},e.prototype.getScene=function(t){var e;return e=this._sceneCache[t.name],null==e&&(e=new ComicScene(t,this._dia,this._selectDia),e.addEventListener(EVENT.PLAY_NEXT_SHOT,this.playNextShot,this),this._sceneCache[t.name]=e),e},e}(egret.DisplayObjectContainer);__reflect(ComicMovie.prototype,"ComicMovie");var ComicScene=function(t){function e(e,i,o){var n=t.call(this)||this;return n.vo=e,n._dia=i,n._selectDia=o,n.dbFactory=dragonBones.EgretFactory.factory,n.dbFactory.autoSearch=!0,n.init(),n.addEventListener(egret.Event.ADDED_TO_STAGE,n.onAdded,n),n}return __extends(e,t),e.prototype.destory=function(){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAdded,this),this.stage.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this)},e.prototype.onAdded=function(t){this.stage.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTap,this)},e.prototype.onTap=function(t){this._curShot&&(this._curShot.type==ComicShotVO.TYPE_ANIM?this._curShot.playComplete?this._curShot.autoPlay||this.playNextShot():this._curShot.skipEnable&&(this._sceneArmature.animation.gotoAndStopByProgress(this._curShot.name,1),this.dispatchEvent(new egret.Event(EVENT.SHOT_COMPLETE))):this._curShot.type==ComicShotVO.TYPE_DIALOG&&(this._curShot.saying?this._curShot.playComplete&&this._curShot.dialogComplete||!this._curShot.skipEnable?this._curShot.autoPlay||this.playNextShot():(this._dia.next(),this._curShot.dialogComplete=!0,this._sceneArmature.animation.gotoAndStopByProgress(this._curShot.name,1),this._curShot.playComplete=!0,this._curShot.dialogComplete=!0,this.dispatchEvent(new egret.Event(EVENT.SHOT_COMPLETE))):this._curShot.playComplete&&this._curShot.dialogComplete&&(this._curShot.autoPlay||this.playNextShot())))},e.prototype.initRole=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,ComicResourceManager.instance.loadRoleAsset("role","shot","cloth")];case 1:return t.sent(),this.setupRole(),this.setupCloth(),[2]}})})},e.prototype.setupRole=function(){var t,e,i=this.vo.getRoleAssets();for(t=0,e=i.length;e>t;t++)this.setupDB(i[t])},e.prototype.setupCloth=function(){var t,e,i=this.vo.getClothAssets();for(t=0,e=i.length;e>t;t++)this.setupDB(i[t])},e.prototype.setupDB=function(t){var e=this.dbFactory;ComicResourceManager.instance.loadDBConfig(e,t)},e.prototype.roleChangeCloth=function(t){var e,i;for(e=0,i=this.vo.roles.length;i>e;e++){var o=this.vo.roles[e],n=o.clothes;if(n&&n.length>0){var s=t.getSlot(o.name);if(s){var r=s.childArmature;if(r){var a=void 0,h=void 0;for(a=0,h=n.length;h>a;a++){var c=n[a],l=this.dbFactory.getArmatureData(c.armature,c.data);l&&this.dbFactory.changeSkin(r,l.defaultSkin)}}}}}},e.prototype.init=function(){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(t){switch(t.label){case 0:return[4,this.initRole()];case 1:return t.sent(),this.initScene(),[2]}})})},e.prototype.initScene=function(){var t=this.dbFactory;ComicResourceManager.instance.loadDBConfig(t,this.vo.asset),this._sceneArmature=t.buildArmatureDisplay(this.vo.name);var e=this._sceneArmature.armature;this.roleChangeCloth(e),this._sceneArmature.addEvent(dragonBones.AnimationEvent.LOOP_COMPLETE,this.onSceneAnimationComplete,this),this.addChild(this._sceneArmature),this.addEventListener(EVENT.SHOT_COMPLETE,this.onShotComplete,this),this._sceneArmature.addEvent(dragonBones.FrameEvent.ANIMATION_FRAME_EVENT,this.onSceneArmatureFrameEvent,this),this._dia.addEventListener(EVENT.DIALOG_OVER,this.onDialogOver,this),this._selectDia.addEventListener(EVENT.DIALOG_SELECT,this.onDialogSelect,this),this._inited=!0,null!=this._initShotVO&&(this.playShot(this._initShotVO),this._initShotVO=null)},e.prototype.removeAllEvent=function(){this._sceneArmature&&(this._sceneArmature.removeEvent(dragonBones.AnimationEvent.LOOP_COMPLETE,this.onSceneAnimationComplete,this),this._sceneArmature.removeEvent(dragonBones.FrameEvent.ANIMATION_FRAME_EVENT,this.onSceneArmatureFrameEvent,this)),this.removeEventListener(EVENT.SHOT_COMPLETE,this.onShotComplete,this),this._dia&&this._dia.removeEventListener(EVENT.DIALOG_OVER,this.onDialogOver,this),this._selectDia&&this._selectDia.removeEventListener(EVENT.DIALOG_SELECT,this.onDialogSelect,this)},e.prototype.onDialogSelect=function(t){this._selectDia.hide(),this._curShot.dialogComplete=!0,this._curShot.saying=!1,this._curShot.selectIndex=t.data,this.checkShotOver()},e.prototype.onDialogOver=function(t){this._curShot.dialogComplete=!0,this._curShot.saying=!1,this.checkShotOver()},e.prototype.onSceneArmatureFrameEvent=function(t){if(t.data&&t.data.name)switch(t.data.name){case"dia":var e=t.data.bone,i=t.data.data,o=i.strings[0],n=i.floats[0]||300;this._dia.speed=n,this._dia.label=o,this._dia.show(),this._curShot.saying=!0;break;case"select":e=t.data.bone,i=t.data.data,o=i.strings[0];var s=o.split("||");this._selectDia.data=s,this._selectDia.show(),this._curShot.saying=!0}},e.prototype.onSceneAnimationComplete=function(t){this._curAnimState.stop(),this.dispatchEvent(new egret.Event(EVENT.SHOT_COMPLETE))},e.prototype.onShotComplete=function(t){console.log(this._curShot.name+"  -complete"),this._curShot.playComplete=!0,this._curShot.nextShot?this.checkShotOver():this.dispatchEvent(new egret.Event(EVENT.MOVIE_COMPLETE))},e.prototype.delayPlayShot=function(t){this._inited?this.playShot(t):this._initShotVO=t},e.prototype.playShot=function(t){this._dia.hide(),this._curShot=t,this._curAnimState=this._sceneArmature.animation.play(t.name)},e.prototype.curShotOver=function(){this._curShot.skipEnable&&this.playNextShot()},e.prototype.playNextShot=function(){this.dispatchEvent(new egret.Event(EVENT.PLAY_NEXT_SHOT))},e.prototype.checkShotOver=function(){if(this._curShot)switch(this._curShot.type){case ComicShotVO.TYPE_ANIM:this._curShot.playComplete&&this.curShotOver();break;case ComicShotVO.TYPE_DIALOG:this._curShot.playComplete&&this._curShot.dialogComplete&&this.curShotOver();break;case ComicShotVO.TYPE_SELECT:this._curShot.playComplete&&this._curShot.dialogComplete&&this._curShot.selectIndex>=0&&this.curShotOver()}},e.prototype.stop=function(){this._curAnimState&&this._curAnimState.stop(),this._sceneArmature&&this._sceneArmature.animation.stop()},e}(egret.DisplayObjectContainer);__reflect(ComicScene.prototype,"ComicScene");var Dialog=function(t){function e(){var e=t.call(this)||this;return e.speed=300,e.waitTime=1e3,e.view=fairygui.UIPackage.createObject("ui","Dialog").asCom,e.txt=e.view.getChild("txt"),e.txt.fontSize=40,e.addChild(e.view),e}return __extends(e,t),Object.defineProperty(e.prototype,"label",{get:function(){return this._label},set:function(t){this._label=t,this._label.length>0&&(this._curTime=0,this._lastTime=0,this._totalTime=this.speed*this._label.length,this.start(),this._animing=!0)},enumerable:!0,configurable:!0}),e.prototype.start=function(){this.hasEventListener(egret.Event.ENTER_FRAME)||this.addEventListener(egret.Event.ENTER_FRAME,this.onTick,this)},e.prototype.stop=function(){this.removeEventListener(egret.Event.ENTER_FRAME,this.onTick,this),this.txt.text=this.label,this._animing&&(this._animing=!1,this.dispatchEvent(new egret.Event(EVENT.DIALOG_OVER)))},e.prototype.next=function(){this._animing&&(this._lastTime=this._totalTime)},e.prototype.hide=function(){this.visible=!1},e.prototype.show=function(){this.visible=!0},e.prototype.onTick=function(t){this.tick(30)},e.prototype.tick=function(t){this._curTime=this._lastTime+t,this._lastTime=this._curTime,this._curTime>this._totalTime+this.waitTime&&this.stop(),this._percent=this._curTime/this._totalTime,this._percent>1&&(this._percent=1);var e=Math.floor(this._label.length*this._percent),i=this._label.substr(0,e);this.txt.text=i},e}(fairygui.GComponent);__reflect(Dialog.prototype,"Dialog");var SelectDialog=function(t){function e(){var e=t.call(this)||this;return e.stageWidth=600,e.stageHeight=800,e.view=fairygui.UIPackage.createObject("ui","SelectDialog").asCom,e.list=e.view.getChild("list"),e.bg=e.view.getChild("n5"),e.list.removeChildrenToPool(),e.addChild(e.view),e.list.addEventListener(fairygui.ItemEvent.CLICK,function(t){var i=t.itemObject.data;e.dispatchEventWith(EVENT.DIALOG_SELECT,!1,i)},e),e}return __extends(e,t),e.prototype.show=function(){this.visible=!0,this.x=(this.stageWidth-this.view.width*this.scaleX)/2,this.y=(this.stageHeight-this.view.height*this.scaleY)/2},e.prototype.hide=function(){this.visible=!1},Object.defineProperty(e.prototype,"data",{set:function(t){var e,i,o;for(this.list.removeChildrenToPool(),e=0,i=t.length;i>e;e++){var n=this.list.addItemFromPool().asCom;n.getChild("txt").text=e+1+"."+t[e],n.data=e,o=n.height}this.bg.height=(o+2)*i+21},enumerable:!0,configurable:!0}),e}(fairygui.GComponent);__reflect(SelectDialog.prototype,"SelectDialog");