var Game=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAdded,this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.onAdded=function(t){this.removeEventListener(egret.Event.ADDED_TO_STAGE,this.onAdded,this),this.init()},s.init=function(){console.log("this is a new game!");var t=new StateManager(this);t.registerState("pageInfo",new PageInfo),t.registerState("pageGame",new PageGame),t.registerState("pageOver",new PageOver),t.setCurStateName("pageInfo"),t.startTick()},e}(egret.DisplayObjectContainer);egret.registerClass(Game,"Game");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),s=i.prototype;return s.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},s.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAddToStage,this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.onAddToStage=function(t){this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},s.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},s.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.addChild(new Game))},s.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},s.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},s.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},s.createGameScene=function(){var t=this.createBitmapByName("bg_jpg");this.addChild(t);var e=this.stage.stageWidth,i=this.stage.stageHeight;t.width=e,t.height=i;var s=new egret.Shape;s.graphics.beginFill(0,.5),s.graphics.drawRect(0,0,e,172),s.graphics.endFill(),s.y=33,this.addChild(s);var n=this.createBitmapByName("egret_icon_png");this.addChild(n),n.x=26,n.y=33;var a=new egret.Shape;a.graphics.lineStyle(2,16777215),a.graphics.moveTo(0,0),a.graphics.lineTo(0,117),a.graphics.endFill(),a.x=172,a.y=61,this.addChild(a);var r=new egret.TextField;r.textColor=16777215,r.width=e-172,r.textAlign="center",r.text="Hello Egret",r.size=24,r.x=172,r.y=80,this.addChild(r);var o=new egret.TextField;this.addChild(o),o.alpha=0,o.width=e-172,o.textAlign=egret.HorizontalAlign.CENTER,o.size=24,o.textColor=16777215,o.x=172,o.y=135,this.textfield=o,RES.getResAsync("description_json",this.startAnimation,this)},s.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e},s.startAnimation=function(t){for(var e=this,i=new egret.HtmlTextParser,s=[],n=0;n<t.length;n++)s.push(i.parser(t[n]));var a=e.textfield,r=-1,o=function(){r++,r>=s.length&&(r=0);var t=s[r];e.changeDescription(a,t);var i=egret.Tween.get(a);i.to({alpha:1},200),i.wait(2e3),i.to({alpha:0},200),i.call(o,e)};o()},s.changeDescription=function(t,e){t.textFlow=e},e}(egret.DisplayObjectContainer);egret.registerClass(Main,"Main");var State=function(t){function e(){t.call(this),this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAdded,this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.onAdded=function(t){this.init()},s.init=function(){console.log("this is a state")},s.show=function(t){t.addChild(this)},s.next=function(t){this.dispatchEvent(new StateEvent(StateEvent.NEXT,t)),this.parent.removeChild(this)},s.tick=function(t){},e}(egret.DisplayObjectContainer);egret.registerClass(State,"State",["IState","egret.IEventDispatcher"]);var PageGame=function(t){function e(){t.call(this),this._pos=0,this._comeSpeed=.05,this._totalTime=4.5,this.conSpeeds=[],this.curSpeed=e.SPEED_0,this.curLevel=0,this.difficult=1,this.bottomNum=0,this.curState=0,this._curTime=0,this._curHit=0,this._roleQueue=[],this._roleBoss=[],this._roleManager=new RoleManager,this._roleContainer=new egret.Sprite,this._uiContainer=new egret.Sprite,this._roleBgContainer=new egret.Sprite,this.hitSound=RES.getRes("yinxiao_wav"),this.bgSound=RES.getRes("yinyue_mp3")}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(){console.log("init pageGame "),this.bgChannel&&this.bgChannel.stop(),this.bgChannel=this.bgSound.play(0,1e3),t.prototype.init.call(this),this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this._curTime=e.TOTAL_TIME,this.curLevel=0,this._curHit=0,this.initRoleQueue(),this._roleContainer.removeChildren(),this._uiContainer.removeChildren(),this.initBg(),this.addChild(this._roleBgContainer),this.addChild(this._roleContainer),this.addChild(this._uiContainer),this.initUI(),this.initRoleBg(),this.initRole(),this.initDifficult(),this.initLevel()},s.initRoleQueue=function(){this._roleQueue.length=0;for(var t=0;10>t;t++)5==t?this.randomRole(!0):this.randomRole()},s.initRole=function(){null!=this._role&&null!=this._role.parent&&this._roleContainer.addChild(this._role),this._curRoleName=this._roleQueue.shift(),this._curBoss=this._roleBoss.shift(),this._role=this._roleManager.getRole(this._curRoleName),this._role.gotoAndStop("wan",0),dragonBones.WorldClock.clock.advanceTime(0),this._curRoleSex=this._roleManager.getRoleSex(this._curRoleName),this._curBoss?this._role.scaleX=this._role.scaleY=1.2:this._role.scaleX=this._role.scaleY=1,this._roleContainer.addChild(this._role),this._role.x=this.stage.stageWidth/2,this._role.y=this.stage.stageHeight-200,this._totalTime=this._role.totleTime;var t=Math.random()<.2;this.randomRole(t)},s.initRoleBg=function(){this._roleBgContainer.removeChildren();for(var t=this._roleQueue.length-1;t>=1;t--){var e=this.createBitmapByName(this._roleQueue[t]+"_png");e.x=this.stage.stageWidth/2+40*t,e.y=this.stage.stageHeight-200-50*t-e.height/2,this._roleBgContainer.addChild(e)}},s.randomRole=function(t){void 0===t&&(t=!1);var e=Math.floor(Math.random()*RoleManager.ROLES.length),i=RoleManager.ROLES[e];this._roleQueue.push(i),this._roleBoss.push(t)},s.initBg=function(){this._bg=this.createBitmapByName("bg_jpg"),this._bg.x=this.stage.stageWidth/2,this._bg.y=this.stage.stageHeight/2,this.addChild(this._bg)},s.initUI=function(){this._btn0=this.createBitmapByName("btn_nv_png"),this._btn0.x=this.stage.stageWidth/2-100,this._btn0.y=this.stage.stageHeight-100,this._uiContainer.addChild(this._btn0),this._btn1=this.createBitmapByName("btn_nv1_png"),this._btn1.x=this.stage.stageWidth/2-100,this._btn1.y=this.stage.stageHeight-100,this._uiContainer.addChild(this._btn1),this._btn1.visible=!1,this._btn2=this.createBitmapByName("btn_nan_png"),this._btn2.x=this.stage.stageWidth/2+100,this._btn2.y=this.stage.stageHeight-100,this._uiContainer.addChild(this._btn2),this._btn3=this.createBitmapByName("btn_nan1_png"),this._btn3.x=this.stage.stageWidth/2+100,this._btn3.y=this.stage.stageHeight-100,this._uiContainer.addChild(this._btn3),this._btn3.visible=!1,this._txtTime=new egret.TextField,this._txtTime.x=10,this._txtTime.y=10,this._uiContainer.addChild(this._txtTime)},s.refreshBtn=function(){this._curBoss?(this._btn0.visible=!1,this._btn1.visible=!1,this._btn2.visible=!1,this._btn3.visible=!1):(this._btn0.visible=!0,this._btn1.visible=!1,this._btn2.visible=!0,this._btn3.visible=!1)},s.refreshUI=function(){this._txtTime.text=this._curTime/1e3+"seconds"},s.initDifficult=function(){this.difficult=Math.floor(3*Math.random()),this._curBoss&&(this.difficult=3),this.conSpeeds=e.CON_SPEED_ARR[this.difficult],this.curConSpeed=this.conSpeeds[0],this.curSpeed=this._totalTime/e.SPEED_ARR[this.difficult]},s.initLevel=function(){this.curState=e.STATE_START,this._pos=0},s.tick=function(t){switch(this._curTime-=t,this._curTime<=0&&this.endGame(),this.curState){case e.STATE_START:this.tickStart(t);break;case e.STATE_RUN:this.tickRun(t);break;case e.STATE_END:this.tickEnd(t)}this.refreshUI()},s.tickStart=function(t){this.curState=e.STATE_RUN},s.tickEnd=function(t){var e=this,i=egret.Tween.get(this._role);1==this._curRoleSex?i.to({x:this.stage.stageWidth+200},200):i.to({x:-200},200),i.call(this.nextLevel,e)},s.nextLevel=function(){egret.Tween.removeTweens(this._role),this.curLevel++,this.initRoleBg(),this.initRole(),this.initDifficult(),this.initLevel(),this.refreshBtn()},s.tickRun=function(t){this._pos>.9*this._totalTime?this.curConSpeed=this.conSpeeds[2]:this._pos>.3*this._totalTime?this.curConSpeed=this.conSpeeds[1]:this.curConSpeed=this.conSpeeds[0],this._pos+=this.curConSpeed,this._pos>=this._totalTime?(this._realPos=this._totalTime-.001,this.bottomNum++,this.bottomNum>=e.LEVEL_COMPLETE_BOTTOM_NUM&&this.levelComplete()):(this._realPos=this._pos,this.bottomNum>0&&this.bottomNum--),this._role.gotoAndStop("wan",this._realPos),dragonBones.WorldClock.clock.advanceTime(t/1e3)},s.endGame=function(){this.curState=e.STATE_OVER,ScoreManager.curScore=this.curLevel,this.curLevel>ScoreManager.maxScore&&(ScoreManager.maxScore=this.curLevel),ScoreManager.curHit=this._curHit,this._curHit>ScoreManager.maxHit&&(ScoreManager.maxHit=this._curHit),this.over()},s.dispose=function(){this.removeChildren(),this.stage&&this.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this)},s.onTouchBegin=function(t){var e=t.stageX,i=this.stage.stageWidth/2;this._curBoss?(this._pos+=this.curSpeed,this._curHit++,this.hitSound.play(0,1)):1==this._curRoleSex?i>e||(this._pos+=this.curSpeed,this._curHit++,this._btn2.visible=!1,this._btn3.visible=!0,this.hitSound.play(0,1)):0==this._curRoleSex&&i>e&&(this._pos+=this.curSpeed,this._curHit++,this._btn0.visible=!1,this._btn1.visible=!0,this.hitSound.play(0,1))},s.onTouchEnd=function(t){this._curBoss||(this._btn1.visible=!1,this._btn0.visible=!0,this._btn3.visible=!1,this._btn2.visible=!0)},s.levelComplete=function(){this.curState=e.STATE_END,console.log("level complete")},s.over=function(){this.dispose(),this.next("pageOver")},s.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e},e.SPEED_0=1,e.SPEED_1=2,e.SPEED_2=3,e.SPEED_3=50,e.SPEED_ARR=[e.SPEED_0,e.SPEED_1,e.SPEED_2,e.SPEED_3],e.CON_SPEED_0=[0,0,0],e.CON_SPEED_1=[0,0,0],e.CON_SPEED_2=[0,0,0],e.CON_SPEED_3=[-.001,-.002,-.003],e.CON_SPEED_ARR=[e.CON_SPEED_0,e.CON_SPEED_1,e.CON_SPEED_2,e.CON_SPEED_3],e.LEVEL_COMPLETE_BOTTOM_NUM=3,e.TOTAL_TIME=6e4,e.STATE_START=0,e.STATE_RUN=1,e.STATE_END=2,e.STATE_OVER=4,e}(State);egret.registerClass(PageGame,"PageGame");var PageInfo=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(){t.prototype.init.call(this),this.stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this),this.stage.addEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this._bg=this.createBitmapByName("bg_jpg"),this.addChild(this._bg),this._bg.x=this.stage.stageWidth/2,this._bg.y=this.stage.stageHeight/2,this._title=this.createBitmapByName("titleCover_png"),this._title.x=this.stage.stageWidth/2+10,this._title.y=this.stage.stageHeight/2+10,this.addChild(this._title),this._btn1=this.createBitmapByName("btn_start1_png"),this._btn1.x=this.stage.stageWidth/2+10,this._btn1.y=this.stage.stageHeight/2+410,this.addChild(this._btn1),this._btn=this.createBitmapByName("btn_start_png"),this._btn.x=this.stage.stageWidth/2+10,this._btn.y=this.stage.stageHeight/2+410,this.addChild(this._btn),this._btn1.visible=!1;var e=Math.floor(Math.random()*RoleManager.ROLES.length),i=RoleManager.ROLES[e];this._man=this.createBitmapByName(i+"_png"),this._man.x=this.stage.stageWidth/2,this._man.y=this.stage.stageHeight/2+100,this.addChild(this._man),this._logo=this.createBitmapByName("logo_png"),this._logo.x=this.stage.stageWidth/2+150,this._logo.y=this.stage.stageHeight/2-350,this.addChild(this._logo)},s.tick=function(t){},s.dispose=function(){this.removeChildren(),this.stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouchBegin,this)},s.onTouchBegin=function(t){this._btn1.visible=!0,this._btn.visible=!1},s.onTouchEnd=function(t){this.over()},s.over=function(){this.dispose(),this.next("pageGame")},s.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e},e}(State);egret.registerClass(PageInfo,"PageInfo");var PageOver=function(t){function e(){t.call(this),this._txtScore=new egret.TextField,this._txtMaxScore=new egret.TextField,this._txtHit=new egret.TextField,this._txtMaxHit=new egret.TextField}__extends(e,t);var i=(__define,e),s=i.prototype;return s.init=function(){t.prototype.init.call(this),this._bg=this.createBitmapByName("bg_jpg"),this.addChild(this._bg),this.x=this.stage.stageWidth/2,this.y=this.stage.stageHeight/2,this._title=this.createBitmapByName("over_png"),this.addChild(this._title),this._txtScore.text=ScoreManager.curScore.toString(),this._txtScore.size=50,this._txtScore.x=-50,this._txtScore.y=60,this.addChild(this._txtScore),this._scoreIcon=this.createBitmapByName("score_png"),this._scoreIcon.x=50,this._scoreIcon.y=80,this.addChild(this._scoreIcon),this._txtMaxScore.text=ScoreManager.maxScore.toString(),this._txtMaxScore.y=10,this._txtHit.text=ScoreManager.curHit.toString(),this._txtHit.y=30,this._txtMaxHit.text=ScoreManager.maxHit.toString(),this._txtMaxHit.y=50,this._btn=this.createBitmapByName("btn_start1_png"),this._btn.y=200,this._btn.touchEnabled=!0,this._btn.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchEnd,this),this.addChild(this._btn)},s.tick=function(t){},s.dispose=function(){this.removeChildren(),this._btn.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onTouchEnd,this)},s.onTouchEnd=function(t){this.over()},s.over=function(){this.dispose(),this.next("pageInfo")},s.createBitmapByName=function(t){var e=new egret.Bitmap,i=RES.getRes(t);return e.texture=i,e.anchorOffsetX=e.width/2,e.anchorOffsetY=e.height/2,e},e}(State);egret.registerClass(PageOver,"PageOver");var Role=function(t){function e(e,i){void 0===e&&(e="man1"),void 0===i&&(i=1),t.call(this),this.name=e,this._scale=i,console.log("name armature",e);var s=RES.getRes(e+"_json"),n=RES.getRes(e+"_texture_json"),a=RES.getRes(e+"_texture_png");console.log(s),console.log(n),console.log(a);var r=new dragonBones.EgretFactory;r.addSkeletonData(dragonBones.DataParser.parseDragonBonesData(s)),r.addTextureAtlas(new dragonBones.EgretTextureAtlas(a,n)),this.armature=r.buildArmature(e);var o=this.armature.display;o.scaleX=this._scale,o.scaleY=this._scale,dragonBones.WorldClock.clock.add(this.armature),this.addChild(o)}__extends(e,t);var i=__define,s=e,n=s.prototype;return n.play=function(t){this.armature.animation.gotoAndPlay(t,0,-1,1)},n.gotoAndStop=function(t,e){this.armature.animation.gotoAndStop(t,e)},i(n,"totleTime",function(){return this.armature.animation.lastAnimationState.totalTime}),n.remove=function(){dragonBones.WorldClock.clock.remove(this.armature)},e}(egret.Sprite);egret.registerClass(Role,"Role");var RoleManager=function(){function t(){this._roleDict={},this._roleSex={},this._roleSex.man1=1,this._roleSex.man2=1,this._roleSex.man3=1,this._roleSex.woman1=0,this._roleSex.woman2=0,this._roleSex.woman3=0}var e=(__define,t),i=e.prototype;return i.getRole=function(t){return console.log(t),null==this._roleDict[t]&&(this._roleDict[t]=new Role(t,1)),this._roleDict[t]},i.getRoleSex=function(t){return this._roleSex[t]},t.ROLES=["man1","man2","man3","woman1","woman2","woman3"],t}();egret.registerClass(RoleManager,"RoleManager");var ScoreManager=function(){function t(){}var e=(__define,t);e.prototype;return t.curScore=0,t.maxScore=0,t.curHit=0,t.maxHit=0,t}();egret.registerClass(ScoreManager,"ScoreManager");var StateEvent=function(t){function e(e,i,s,n){void 0===s&&(s=!1),void 0===n&&(n=!1),t.call(this,e,s,n),this.data=i}__extends(e,t);var i=(__define,e);i.prototype;return e.NEXT="NEXT",e}(egret.Event);egret.registerClass(StateEvent,"StateEvent");var StateManager=function(){function t(t){this._parent=t,this._stateObj={}}var e=(__define,t),i=e.prototype;return i.startTick=function(){this._curTime=egret.getTimer(),egret.startTick(this.tick,this)},i.stopTick=function(){egret.stopTick(this.tick,this)},i.tick=function(t){return this._lastTime=this._curTime,this._curTime=t,this._curState&&this._curState.tick(this._curTime-this._lastTime),!0},i.registerState=function(t,e){this._stateObj[t]=e},i.setCurStateName=function(t){var e=this._stateObj[t];e&&this.setCurState(e)},i.setCurState=function(t){this._curState&&(this._curState.removeEventListener(StateEvent.NEXT,this.onNext,this),this._prevState=this._curState),this._curState=t,this._curState.show(this._parent),this._curState.addEventListener(StateEvent.NEXT,this.onNext,this)},i.onNext=function(t){var e=this._stateObj[t.data];e&&this.setCurState(e)},t}();egret.registerClass(StateManager,"StateManager");