var AssetAdapter=function(){function t(){}var e=(__define,t),i=e.prototype;return i.getAsset=function(t,e,i){function n(n){e.call(i,n,t)}if(RES.hasRes(t)){var s=RES.getRes(t);s?n(s):RES.getResAsync(t,n,this)}else RES.getResByUrl(t,n,this,RES.ResourceItem.TYPE_IMAGE)},t}();egret.registerClass(AssetAdapter,"AssetAdapter",["eui.IAssetAdapter"]);var BaseCommand=function(){function t(){this.canUndo=!1,this.canMerge=!1}var e=(__define,t),i=e.prototype;return i.initData=function(t){this.inputData=t},i.merge=function(t){return!1},i.execuse=function(){},i.revert=function(){},t}();egret.registerClass(BaseCommand,"BaseCommand");var BlockCmd=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.execuse=function(){this.commandManager.block()},i(s,"commandManager",function(){return ControlManager.instance.commandManager}),e}(BaseCommand);egret.registerClass(BlockCmd,"BlockCmd");var CommandNotification=function(){function t(){}var e=(__define,t);e.prototype;return t.getCommand=function(t){var e=egret.getDefinitionByName(t);if(e){var i=new e;return i}return null},t.UNDO="UndoCmd",t.REDO="RedoCmd",t.BLOCK="BlockCmd",t.CREATE_ROOM="CreateRoomCmd",t.CREATE_WALL="CreateWallCmd",t.MODIFY_ROOM="ModifyRoomCmd",t.MODIFY_POINT="ModifyPointCmd",t._map={},t}();egret.registerClass(CommandNotification,"CommandNotification");var BaseControl=function(){function t(){this._bus=SignBus.instance,this._commandNotification=new Notification(Notification.COMMAND),this._commandData={}}var e=(__define,t),i=e.prototype;return i.on=function(t,e,i){void 0===i&&(i=0),this._bus.addEventListener(t,e,this,!1,i)},i.off=function(t,e){this._bus.removeEventListener(t,e,this)},i.send=function(t,e){void 0===e&&(e=null),this._bus.dispatchEvent(new Notification(t,e))},i.sendCommand=function(t,e){void 0===e&&(e=null),this._commandData.command=t,this._commandData.data=e,this._commandNotification.data=this._commandData,this._bus.dispatchEvent(this._commandNotification)},i.start=function(){this._running||(this.initListener(),this._running=!0)},i.stop=function(){this._running=!1,this.removeListener()},i.initListener=function(){},i.removeListener=function(){},t}();egret.registerClass(BaseControl,"BaseControl");var CommandManager=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.initWithModel=function(t){this._model=t,this.start()},s.initListener=function(){this.on(Notification.COMMAND,this.onCommand)},s.onCommand=function(t){var e=t.data.command,i=t.data.data,n=CommandNotification.getCommand(e),s=0;if(null!=n&&(n.initData(i),n.execuse(),n.canUndo))if(n.canMerge&&this._model.curCommand&&this._model.curCommand.canMerge){var o=this._model.curCommand.merge(n);o||(s=this._model.commandList.length,s>this._model.curIndex+1&&this._model.commandList.splice(this._model.curIndex+1,s-this._model.curIndex-1),this._model.curCommand.canMerge=!1,this._model.commandList.push(n),this._model.curIndex++)}else s=this._model.commandList.length,s>this._model.curIndex+1&&this._model.commandList.splice(this._model.curIndex+1,s-this._model.curIndex-1),this._model.commandList.push(n),this._model.curIndex++},s.block=function(){this._model.curCommand&&(this._model.curCommand.canMerge=!1)},s.undo=function(){var t=this._model.curCommand;t&&(t.revert(),this._model.curIndex--)},s.redo=function(){var t=this._model.nextCommand;t&&(t.execuse(),this._model.curIndex++)},i(s,"redoEnable",function(){return this._model.redoEnable}),i(s,"undoEnable",function(){return this._model.undoEnable}),e}(BaseControl);egret.registerClass(CommandManager,"CommandManager");var CommandModel=function(){function t(){this.curIndex=-1,this.savedIndex=-1,this.commandList=[]}var e=__define,i=t,n=i.prototype;return e(n,"curCommand",function(){return this.commandList[this.curIndex]}),e(n,"nextCommand",function(){return this.curIndex<this.commandList.length-1?this.commandList[this.curIndex+1]:null}),e(n,"redoEnable",function(){return this.curIndex<this.commandList.length-1}),e(n,"undoEnable",function(){return this.curIndex>=0}),t}();egret.registerClass(CommandModel,"CommandModel");var CreateRoomCmd=function(t){function e(){t.call(this),this.canUndo=!0,this.canMerge=!1}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.execuse=function(){var t,e,i=ControlManager.instance.mainViewControl.houseVO;for(t=0,e=this.delWalls.length;e>t;++t)i.removeWall(this.delWalls[t]);for(t=0,e=this.addWalls.length;e>t;++t)i.addWall(this.addWalls[t]);ControlManager.instance.mainViewControl.wallViewControl.refresh()},s.revert=function(){var t,e,i=ControlManager.instance.mainViewControl.houseVO;for(t=0,e=this.addWalls.length;e>t;++t)i.removeWall(this.addWalls[t]);for(t=0,e=this.delWalls.length;e>t;++t)i.addWall(this.delWalls[t]);ControlManager.instance.mainViewControl.wallViewControl.refresh()},i(s,"addWalls",function(){return this.inputData.addWalls}),i(s,"delWalls",function(){return this.inputData.delWalls}),e}(BaseCommand);egret.registerClass(CreateRoomCmd,"CreateRoomCmd");var CreateWallCmd=function(t){function e(){t.call(this),this.canUndo=!0,this.canMerge=!1}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.execuse=function(){var t,e,i=ControlManager.instance.mainViewControl.houseVO;for(t=0,e=this.delWalls.length;e>t;++t)i.removeWall(this.delWalls[t]);for(t=0,e=this.addWalls.length;e>t;++t)i.addWall(this.addWalls[t]);ControlManager.instance.mainViewControl.wallViewControl.refresh()},s.revert=function(){var t,e,i=ControlManager.instance.mainViewControl.houseVO;for(t=0,e=this.addWalls.length;e>t;++t)i.removeWall(this.addWalls[t]);for(t=0,e=this.delWalls.length;e>t;++t)i.addWall(this.delWalls[t]);ControlManager.instance.mainViewControl.wallViewControl.refresh()},i(s,"addWalls",function(){return this.inputData.addWalls}),i(s,"delWalls",function(){return this.inputData.delWalls}),e}(BaseCommand);egret.registerClass(CreateWallCmd,"CreateWallCmd");var ModifyPointCmd=function(t){function e(){t.call(this),this.canUndo=!0,this.canMerge=!1}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.initData=function(t){this.inputData=t},s.execuse=function(){this.point.x=this.newX,this.point.y=this.newY,ControlManager.instance.mainViewControl.wallViewControl.refresh()},s.revert=function(){this.point.x=this.oldX,this.point.y=this.oldY,ControlManager.instance.mainViewControl.wallViewControl.refresh()},i(s,"point",function(){return this.inputData.point}),i(s,"oldX",function(){return this.inputData.oldX}),i(s,"oldY",function(){return this.inputData.oldY}),i(s,"newX",function(){return this.inputData.newX}),i(s,"newY",function(){return this.inputData.newY}),e}(BaseCommand);egret.registerClass(ModifyPointCmd,"ModifyPointCmd");var ModifyRoomCmd=function(t){function e(){t.call(this),this.canUndo=!0,this.canMerge=!0}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initData=function(t){this.inputData=t},n.merge=function(t){if(egret.is(t,"ModifyRoomCmd")){var e=t;if(e.inputData.room==this.inputData.room)return!0}return!1},n.execuse=function(){var t=this.inputData.room,e=this.inputData.p0,i=this.inputData.p1;t&&(t.reSize(e,i),ControlManager.instance.mainViewControl.wallViewControl.refresh())},n.revert=function(){},e}(BaseCommand);egret.registerClass(ModifyRoomCmd,"ModifyRoomCmd");var RedoCmd=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.execuse=function(){this.commandManager.redoEnable&&this.commandManager.redo()},i(s,"commandManager",function(){return ControlManager.instance.commandManager}),e}(BaseCommand);egret.registerClass(RedoCmd,"RedoCmd");var UndoCmd=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.execuse=function(){this.commandManager.undoEnable&&this.commandManager.undo()},i(s,"commandManager",function(){return ControlManager.instance.commandManager}),e}(BaseCommand);egret.registerClass(UndoCmd,"UndoCmd");var ControlManager=function(){function t(){var t=document.getElementsByTagName("CANVAS")[0];t&&Cursor.init(t),this.commandManager=new CommandManager,this.commandManager.initWithModel(new CommandModel),this.mainViewControl=new MainViewControl}var e=__define,i=t;i.prototype;return e(t,"instance",function(){return null==t._instance&&(t._instance=new t),t._instance}),t}();egret.registerClass(ControlManager,"ControlManager");var FSM=function(){function t(){this._states=[]}var e=__define,i=t,n=i.prototype;return n.init=function(t){this.switchTo(t)},n.addState=function(t){var e=this.getState(t);return null==e&&(e=new State(t),this._states.push(e)),e},n.removeState=function(t){var e,i;for(e=this._states.length-1;e>=0;--e)if(this._states[e].name==t)return i=this._states.splice(e,1),i[0];return null},n.getState=function(t){var e;for(e=this._states.length-1;e>=0;--e)if(this._states[e].name==t)return this._states[e]},e(n,"currentState",function(){return null==this._curState?null:this._curState.name}),n.switchTo=function(t){if(null!=this._curState){if(this._curState.name==t)return;this._curState.end()}this._curState=this.getState(t),this._curState&&this._curState.start()},n.pushFront=function(t,e){var i=this.getState(t);i&&i.pushFront(e)},n.pushBack=function(t,e){var i=this.getState(t);i&&i.pushBack(e)},t}();egret.registerClass(FSM,"FSM");var State=function(){function t(t){this._name=t,this._beginFun=[],this._endFun=[]}var e=__define,i=t,n=i.prototype;return e(n,"name",function(){return this._name}),n.pushFront=function(t){t&&-1==this._beginFun.indexOf(t)&&this._beginFun.push(t)},n.pushBack=function(t){t&&-1==this._endFun.indexOf(t)&&this._endFun.push(t)},n.start=function(){var t,e=this._beginFun.length;for(t=0;e>t;++t)this._beginFun[t].call(this)},n.end=function(){var t,e=this._endFun.length;for(t=0;e>t;++t)this._endFun[t].call(this)},t}();egret.registerClass(State,"State");var Notification=function(t){function e(e,i){void 0===i&&(i=null),t.call(this,e,!1,!1,i)}__extends(e,t);var i=(__define,e);i.prototype;return e.COMMAND="NOTIFICATION:COMMAND",e}(egret.Event);egret.registerClass(Notification,"Notification");var SignBus=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e;n.prototype;return i(e,"instance",function(){return null==e._instance&&(e._instance=new e),e._instance}),e}(egret.Sprite);egret.registerClass(SignBus,"SignBus");var DMath=function(){function t(){}var e=(__define,t);e.prototype;return t.segmentsIntr=function(t,e,i,n){var s=[],o=(t.x-i.x)*(e.y-i.y)-(t.y-i.y)*(e.x-i.x),r=(t.x-n.x)*(e.y-n.y)-(t.y-n.y)*(e.x-n.x),a=o*r;if(a>0)return null;var h=(i.x-t.x)*(n.y-t.y)-(i.y-t.y)*(n.x-t.x),l=h+o-r,_=h*l;if(_>0)return null;if(0==a||0==_){if(0==a&&0==_)return this.isPointOnSegment(i,t,e)&&s.push(i),this.isPointOnSegment(n,t,e)&&s.push(n),this.isPointOnSegment(t,i,n)&&s.push(t),this.isPointOnSegment(e,i,n)&&s.push(e),2==s.length&&s[0].x==s[1].x&&s[0].y==s[1].y&&(s[0]=null),s;if(0==o){if(this.isPointOnSegment(i,t,e))return console.log("c"),s.push(null),s.push(i),s}else if(0==r){if(this.isPointOnSegment(n,t,e))return s.push(null),s.push(n),s}else if(0==h){if(this.isPointOnSegment(t,i,n))return console.log("a"),s.push(null),s.push(t),s}else if(0==l&&this.isPointOnSegment(e,i,n))return console.log("b"),s.push(null),s.push(e),s}var u=h/(r-o),c=u*(e.x-t.x),d=u*(e.y-t.y),f=new egret.Point(Math.round(t.x+c),Math.round(t.y+d));return s.push(f),s},t.isPointOnSegment=function(t,e,i){return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)!=0?!1:t.x>e.x&&t.x>i.x||t.x<e.x&&t.x<i.x?!1:t.y>e.y&&t.y>i.y||t.y<e.y&&t.y<i.y?!1:!0},t}();egret.registerClass(DMath,"DMath");var DrawBaseControl=function(t){function e(e){var i=this;t.call(this),this.autoClose=!0,this.closeOff=10,this.STATE_NONE="STATE_NONE",this.STATE_NORMAL="STATE_NOMAL",this.STATE_MOVE="STATE_MOVE",this._stage=e,this._startP=new egret.Point,this._endP=new egret.Point,this._viewStartP=new egret.Point,this._viewEndP=new egret.Point,this._cursorP=new egret.Point,this._helpGlobalP=new egret.Point,this._realHelpLine=new LineVO(this._startP,this._endP),this._fsm=new FSM,this._fsm.addState(this.STATE_NONE),this._fsm.addState(this.STATE_NORMAL),this._fsm.addState(this.STATE_MOVE),this._fsm.pushFront(this.STATE_NORMAL,function(){i._stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i)}),this._fsm.pushBack(this.STATE_NORMAL,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i)}),this._fsm.pushFront(this.STATE_MOVE,function(){i._stage.addEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.addEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)}),this._fsm.pushBack(this.STATE_MOVE,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)}),this._fsm.pushFront(this.STATE_NONE,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i),i._stage.removeEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)})}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.initListener=function(){Cursor.setCursor(Cursor.CROSS),this._fsm.switchTo(this.STATE_NORMAL),this._stage.addEventListener(mouse.MouseEvent.MOUSE_MOVE,this.onCursorMove,this,!1,100)},s.removeListener=function(){Cursor.setCursor(Cursor.AUTO),this._fsm.switchTo(this.STATE_NONE),this._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,this.onCursorMove,this,!1)},s.onCursorMove=function(t){if(this._cursorP.x=t.stageX,this._cursorP.y=t.stageY,this.autoClose){var e,i,n,s,o=void 0,r=void 0,a=this.closeOff,h=this.closeOff;if(this.houseVO&&this.houseVO.pointList){for(e=0,i=this.houseVO.pointList.length;i>e;++e)n=this.houseVO.pointList[e],this.viewLocalToStage(n,this._helpGlobalP),s=Math.abs(this._helpGlobalP.x-this._cursorP.x),a>s&&(a=s,o=this._helpGlobalP.x),s=Math.abs(this._helpGlobalP.y-this._cursorP.y),h>s&&(h=s,r=this._helpGlobalP.y);isNaN(o)||(this._cursorP.x=o),isNaN(r)||(this._cursorP.y=r)}}Cursor.x=this._cursorP.x,Cursor.y=this._cursorP.y},s.onTouchBegin=function(t){this._fsm.currentState==this.STATE_NORMAL&&(this._startP.x=this._cursorP.x,this._startP.y=this._cursorP.y,this._endP.x=this._startP.x,this._endP.y=this._startP.y,this._fsm.switchTo(this.STATE_MOVE))},s.onTouchMove=function(t){if(this._endP.x=this._cursorP.x,this._endP.y=this._cursorP.y,this._startP.x!=this._endP.x||this._startP.y!=this._endP.y)if(null==this._helpLine){this.stageToLocal();var e=new PointVO(this._viewStartP.x,this._viewStartP.y),i=new PointVO(this._viewEndP.x,this._viewEndP.y);this._helpLine=new LineVO(e,i),this.startTouchMove()}else{if(this.stageToLocal(),this.autoClose){var n=Math.abs(this._realHelpLine.tg);.05>n?(this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewStartP.x,this._helpLine.p1.y=this._viewEndP.y):n>=20?(this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewEndP.x,this._helpLine.p1.y=this._viewStartP.y):(this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewEndP.x,this._helpLine.p1.y=this._viewEndP.y)}else this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewEndP.x,this._helpLine.p1.y=this._viewEndP.y;this.refresTouchMove()}},s.startTouchMove=function(){},s.refresTouchMove=function(){},s.onTouchEnd=function(t){this._fsm.currentState==this.STATE_MOVE&&(this._startP.x!=this._endP.x||this._startP.y!=this._endP.y)&&this._fsm.switchTo(this.STATE_NORMAL)},s.stageToLocal=function(){var t=ControlManager.instance.mainViewControl.view.wallView;t.globalToLocal(this._startP.x,this._startP.y,this._viewStartP),t.globalToLocal(this._endP.x,this._endP.y,this._viewEndP)},s.viewLocalToStage=function(t,e){var i=ControlManager.instance.mainViewControl.view.wallView;i.localToGlobal(t.x,t.y,e)},i(s,"houseVO",function(){return ControlManager.instance.mainViewControl.houseVO}),e}(BaseControl);egret.registerClass(DrawBaseControl,"DrawBaseControl");var DrawRoomControl=function(t){function e(e){var i=this;t.call(this,e),this._fsm.pushBack(this.STATE_MOVE,function(){if(i._roomVO){var t=ControlManager.instance.mainViewControl.wallViewControl.checkRectRoomWall(i._roomVO);null!=t&&i.sendCommand(CommandNotification.CREATE_ROOM,t)}i._roomVO=null,i._helpLine=null})}__extends(e,t);var i=(__define,e),n=i.prototype;return n.startTouchMove=function(){null==this._roomVO&&(this._roomVO=new RectRoomVO(this._viewStartP,this._viewEndP),this.send(ViewNotification.ADD_HELP_ROOM,this._roomVO))},n.refresTouchMove=function(){this._roomVO&&(this._roomVO.reSize(this._viewStartP,this._viewEndP),this.send(ViewNotification.REFRESH_HELP_ROOM))},e}(DrawBaseControl);egret.registerClass(DrawRoomControl,"DrawRoomControl");var DrawRoomControl2=function(t){function e(e){var i=this;t.call(this),this.STATE_NONE="STATE_NONE",this.STATE_NORMAL="STATE_NOMAL",this.STATE_MOVE="STATE_MOVE",this._stage=e,this._startP=new egret.Point,this._endP=new egret.Point,this._viewStartP=new egret.Point,this._viewEndP=new egret.Point,this._fsm=new FSM,this._fsm.addState(this.STATE_NONE),this._fsm.addState(this.STATE_NORMAL),this._fsm.addState(this.STATE_MOVE),this._fsm.pushFront(this.STATE_NORMAL,function(){i._stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i)}),this._fsm.pushBack(this.STATE_NORMAL,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i)}),this._fsm.pushFront(this.STATE_MOVE,function(){i._stage.addEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.addEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)}),this._fsm.pushBack(this.STATE_MOVE,function(){if(i._stage.removeEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i),i._roomVO){var t=ControlManager.instance.mainViewControl.wallViewControl.checkRectRoomWall(i._roomVO);null!=t&&i.sendCommand(CommandNotification.CREATE_ROOM,t)}i._roomVO=null}),this._fsm.pushFront(this.STATE_NONE,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i),i._stage.removeEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)})}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initListener=function(){this._fsm.switchTo(this.STATE_NORMAL)},n.removeListener=function(){this._fsm.switchTo(this.STATE_NONE)},n.onTouchBegin=function(t){this._fsm.currentState==this.STATE_NORMAL&&(this._startP.x=t.stageX,this._startP.y=t.stageY,this._endP.x=this._startP.x,this._endP.y=this._startP.y,this._fsm.switchTo(this.STATE_MOVE))},n.onTouchMove=function(t){this._endP.x=t.stageX,this._endP.y=t.stageY,(this._startP.x!=this._endP.x||this._startP.y!=this._endP.y)&&(null==this._roomVO?(this.stageToLocal(),this._roomVO=new RectRoomVO(this._viewStartP,this._viewEndP),this.send(ViewNotification.ADD_HELP_ROOM,this._roomVO)):(this.stageToLocal(),this._roomVO.reSize(this._viewStartP,this._viewEndP),this.send(ViewNotification.REFRESH_HELP_ROOM)))},n.onTouchEnd=function(t){this._fsm.currentState==this.STATE_MOVE&&(this._startP.x!=this._endP.x||this._startP.y!=this._endP.y)&&this._fsm.switchTo(this.STATE_NORMAL)},n.stageToLocal=function(){var t=ControlManager.instance.mainViewControl.view.wallView;t.globalToLocal(this._startP.x,this._startP.y,this._viewStartP),t.globalToLocal(this._endP.x,this._endP.y,this._viewEndP)},e}(BaseControl);egret.registerClass(DrawRoomControl2,"DrawRoomControl2");var DrawWallControl=function(t){function e(e){var i=this;t.call(this,e),this._fsm.pushBack(this.STATE_MOVE,function(){if(i._helpLine){var t=ControlManager.instance.mainViewControl.wallViewControl.checkAddLine(i._helpLine);null!=t&&i.sendCommand(CommandNotification.CREATE_WALL,t)}i._helpLine=null})}__extends(e,t);var i=(__define,e),n=i.prototype;return n.startTouchMove=function(){this.send(ViewNotification.ADD_HELP_LINE,this._helpLine)},n.refresTouchMove=function(){this.send(ViewNotification.REFRESH_HELP_LINE)},e}(DrawBaseControl);egret.registerClass(DrawWallControl,"DrawWallControl");var DrawWallControl2=function(t){function e(e){var i=this;t.call(this),this.autoClose=!0,this.closeOff=10,this.STATE_NONE="STATE_NONE",this.STATE_NORMAL="STATE_NOMAL",this.STATE_MOVE="STATE_MOVE",this._stage=e,this._startP=new egret.Point,this._endP=new egret.Point,this._viewStartP=new egret.Point,this._viewEndP=new egret.Point,this._cursorP=new egret.Point,this._helpGlobalP=new egret.Point,this._realHelpLine=new LineVO(this._startP,this._endP),this._fsm=new FSM,this._fsm.addState(this.STATE_NONE),this._fsm.addState(this.STATE_NORMAL),this._fsm.addState(this.STATE_MOVE),this._fsm.pushFront(this.STATE_NORMAL,function(){i._stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i)}),this._fsm.pushBack(this.STATE_NORMAL,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i)}),this._fsm.pushFront(this.STATE_MOVE,function(){i._stage.addEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.addEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)}),this._fsm.pushBack(this.STATE_MOVE,function(){if(i._stage.removeEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i),i._helpLine){var t=ControlManager.instance.mainViewControl.wallViewControl.checkAddLine(i._helpLine);null!=t&&i.sendCommand(CommandNotification.CREATE_WALL,t)}i._helpLine=null}),this._fsm.pushFront(this.STATE_NONE,function(){i._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,i.onTouchBegin,i),i._stage.removeEventListener(egret.TouchEvent.TOUCH_END,i.onTouchEnd,i),i._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,i.onTouchMove,i)})}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.initListener=function(){Cursor.setCursor(Cursor.CROSS),this._fsm.switchTo(this.STATE_NORMAL),this._stage.addEventListener(mouse.MouseEvent.MOUSE_MOVE,this.onCursorMove,this,!1,100)},s.removeListener=function(){Cursor.setCursor(Cursor.AUTO),this._fsm.switchTo(this.STATE_NONE),this._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,this.onCursorMove,this,!1)},s.onCursorMove=function(t){if(this._cursorP.x=t.stageX,this._cursorP.y=t.stageY,this.autoClose){var e,i,n,s,o=void 0,r=void 0,a=this.closeOff,h=this.closeOff;if(this.houseVO&&this.houseVO.pointList){for(e=0,i=this.houseVO.pointList.length;i>e;++e)n=this.houseVO.pointList[e],this.viewLocalToStage(n,this._helpGlobalP),s=Math.abs(this._helpGlobalP.x-this._cursorP.x),a>s&&(a=s,o=this._helpGlobalP.x),s=Math.abs(this._helpGlobalP.y-this._cursorP.y),h>s&&(h=s,r=this._helpGlobalP.y);isNaN(o)||(this._cursorP.x=o),isNaN(r)||(this._cursorP.y=r)}}Cursor.x=this._cursorP.x,Cursor.y=this._cursorP.y},s.onTouchBegin=function(t){this._fsm.currentState==this.STATE_NORMAL&&(this._startP.x=this._cursorP.x,this._startP.y=this._cursorP.y,this._endP.x=this._startP.x,this._endP.y=this._startP.y,this._fsm.switchTo(this.STATE_MOVE))},s.onTouchMove=function(t){if(this._endP.x=this._cursorP.x,this._endP.y=this._cursorP.y,this._startP.x!=this._endP.x||this._startP.y!=this._endP.y)if(null==this._helpLine){this.stageToLocal();var e=new PointVO(this._viewStartP.x,this._viewStartP.y),i=new PointVO(this._viewEndP.x,this._viewEndP.y);this._helpLine=new LineVO(e,i),this.send(ViewNotification.ADD_HELP_LINE,this._helpLine)}else{if(this.stageToLocal(),this.autoClose){var n=Math.abs(this._realHelpLine.tg);.05>n?(this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewStartP.x,this._helpLine.p1.y=this._viewEndP.y):n>=20?(this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewEndP.x,this._helpLine.p1.y=this._viewStartP.y):(this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewEndP.x,this._helpLine.p1.y=this._viewEndP.y)}else this._helpLine.p0.x=this._viewStartP.x,this._helpLine.p0.y=this._viewStartP.y,this._helpLine.p1.x=this._viewEndP.x,this._helpLine.p1.y=this._viewEndP.y;this.send(ViewNotification.REFRESH_HELP_LINE)}},s.onTouchEnd=function(t){this._fsm.currentState==this.STATE_MOVE&&(this._startP.x!=this._endP.x||this._startP.y!=this._endP.y)&&this._fsm.switchTo(this.STATE_NORMAL)},s.stageToLocal=function(){var t=ControlManager.instance.mainViewControl.view.wallView;t.globalToLocal(this._startP.x,this._startP.y,this._viewStartP),t.globalToLocal(this._endP.x,this._endP.y,this._viewEndP)},s.viewLocalToStage=function(t,e){var i=ControlManager.instance.mainViewControl.view.wallView;i.localToGlobal(t.x,t.y,e)},i(s,"houseVO",function(){return ControlManager.instance.mainViewControl.houseVO}),e}(BaseControl);egret.registerClass(DrawWallControl2,"DrawWallControl2");var MainViewControl=function(t){function e(){t.call(this),this.STATE_DRAW_ROOM="STATE_DRAW_ROOM",this.STATE_DRAW_WALL="STATE_DRAW_WALL",this.STATE_NORMAL="STATE_NORMAL",this._houseVO=new HouseVO,this._fsm=new FSM,this.initControl(),this.initState()}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.initControl=function(){this._drawRoomControl=new DrawRoomControl(SignBus.appStage),this._drawWallControl=new DrawWallControl(SignBus.appStage),this._sceneControl=new SceneControl(SignBus.appStage)},s.initState=function(){var t=this;this._fsm.addState(this.STATE_NORMAL),this._fsm.addState(this.STATE_DRAW_ROOM),this._fsm.addState(this.STATE_DRAW_WALL),this._fsm.pushFront(this.STATE_DRAW_ROOM,function(){t._drawRoomControl.start()}),this._fsm.pushBack(this.STATE_DRAW_ROOM,function(){t._drawRoomControl.stop()}),this._fsm.pushFront(this.STATE_DRAW_WALL,function(){t._drawWallControl.start()}),this._fsm.pushBack(this.STATE_DRAW_WALL,function(){t._drawWallControl.stop()}),this._fsm.pushFront(this.STATE_NORMAL,function(){t._sceneControl.start()}),this._fsm.pushBack(this.STATE_NORMAL,function(){t._sceneControl.stop()}),this._fsm.init(this.STATE_NORMAL)},s.initListener=function(){this.on(ViewNotification.MOVE,this.onMove),this._view.mainToolBar.btnRedo.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onRedo,this),this._view.mainToolBar.btnUndo.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onUndo,this),this._view.drawToolBar.btnNormal.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onNormal,this),this._view.drawToolBar.btnDrawRoom.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onRoom,this),this._view.drawToolBar.btnDrawWall.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onWall,this)},s.removeListener=function(){this.off(ViewNotification.TEST,this.onTest)},s.onRedo=function(t){this.sendCommand(CommandNotification.REDO),t.stopImmediatePropagation()},s.onUndo=function(t){this.sendCommand(CommandNotification.UNDO),t.stopImmediatePropagation()},s.onNormal=function(t){this._fsm.switchTo(this.STATE_NORMAL),t.stopImmediatePropagation()},s.onRoom=function(t){this._fsm.switchTo(this.STATE_DRAW_ROOM),t.stopImmediatePropagation()},s.onWall=function(t){this._fsm.switchTo(this.STATE_DRAW_WALL),t.stopImmediatePropagation()},s.onMove=function(t){var e=t.data[0];this._view.grid.moveDelta(e.x,e.y),this._view.wallView.x+=e.x,this._view.wallView.y+=e.y,this._view.wallPointView.x+=e.x,this._view.wallPointView.y+=e.y},s.onTest=function(t){console.log("test",t.data)},i(s,"view",function(){return this._view},function(t){this._view!=t&&(null==t&&this.stop(),this._view=t,null!=this._view&&(this.start(),null==this.wallViewControl&&(this.wallViewControl=new WallViewControl(this._view.wallView,this._view.wallPointView,this._houseVO),this.wallViewControl.start())))}),i(s,"houseVO",function(){return this._houseVO}),e}(BaseControl);egret.registerClass(MainViewControl,"MainViewControl");var ViewNotification=function(){function t(){}var e=(__define,t);e.prototype;return t.TEST="TEST",t.MOVE="ViewNotification:MOVE",t.ADD_HELP_ROOM="ViewNotification:ADD_HELP_ROOM",t.REFRESH_HELP_ROOM="ViewNotification:REFRESH_HELP_ROOM",t.ADD_HELP_LINE="ViewNotification:ADD_HELP_LINE",t.REFRESH_HELP_LINE="ViewNotification:REFRESH_HELP_LINE",t.OVER_POINTVO="ViewNotification:OVER_POINTVO",t.OUT_POINTVO="ViewNotification:OUT_POINTVO",t.UPDATE_WALL_POINT="ViewNotification:UPDATE_WALL_POINT",t}();egret.registerClass(ViewNotification,"ViewNotification");var SceneControl=function(t){function e(e){t.call(this),this.overSize=5,this.STATE_NONE="STATE_NONE",this.STATE_MOVE="STATE_MOVE",this.STATE_NOMAL="STATE_NOMAL",this.STATE_DRAG_POINT="STATE_DRAG_POINT",this._stage=e,this._downPos=new egret.Point,this._deltaPos=new egret.Point,this._curPos=new egret.Point,this._cursorPos=new egret.Point,this._viewMousePos=new egret.Point,this._startDragPoint=new egret.Point,this._posArr=[this._deltaPos,this._curPos],this._fsm=new FSM,this.initState()}__extends(e,t);var i=__define,n=e,s=n.prototype;return s.initState=function(){var t=this;this._fsm.addState(this.STATE_NONE),this._fsm.addState(this.STATE_MOVE),this._fsm.addState(this.STATE_NOMAL),this._fsm.addState(this.STATE_DRAG_POINT),this._fsm.pushFront(this.STATE_MOVE,function(){Cursor.setCursor(Cursor.HAND),t._stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,t.onTouchMove,t),t._stage.addEventListener(egret.TouchEvent.TOUCH_END,t.onTouchEnd,t)}),this._fsm.pushBack(this.STATE_MOVE,function(){t._stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,t.onTouchMove,t),t._stage.removeEventListener(egret.TouchEvent.TOUCH_END,t.onTouchEnd,t)}),this._fsm.pushFront(this.STATE_NOMAL,function(){Cursor.setCursor(Cursor.AUTO),t._stage.addEventListener(mouse.MouseEvent.MOUSE_MOVE,t.onMouseMove,t)}),this._fsm.pushBack(this.STATE_NOMAL,function(){Cursor.setCursor(Cursor.AUTO),t._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,t.onMouseMove,t)}),this._fsm.pushFront(this.STATE_DRAG_POINT,function(){t._stage.addEventListener(egret.TouchEvent.TOUCH_MOVE,t.onDragMove,t),t._stage.addEventListener(egret.TouchEvent.TOUCH_END,t.onDragEnd,t)}),this._fsm.pushBack(this.STATE_DRAG_POINT,function(){t._stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,t.onDragMove,t),t._stage.removeEventListener(egret.TouchEvent.TOUCH_END,t.onDragEnd,t)}),this._fsm.init(this.STATE_NOMAL)},s.initListener=function(){this._stage.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),this._fsm.switchTo(this.STATE_NOMAL)},s.removeListener=function(){this._stage.removeEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onTouch,this),this._stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this._stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this._stage.removeEventListener(mouse.MouseEvent.MOUSE_MOVE,this.onMouseMove,this),this._fsm.switchTo(this.STATE_NONE)},s.onMouseMove=function(t){this._cursorPos.x=t.stageX,this._cursorPos.y=t.stageY,this._viewMousePos.x=this._cursorPos.x-=this.wallView.x,this._viewMousePos.y=this._cursorPos.y-=this.wallView.y,this._overPoint=this.getOverPoint(this._viewMousePos),null==this._lastOverPoint&&null!=this._overPoint?this.send(ViewNotification.OVER_POINTVO,this._overPoint):null!=this._lastOverPoint&&null==this._overPoint&&this.send(ViewNotification.OUT_POINTVO,this._lastOverPoint),this._lastOverPoint=this._overPoint},s.getOverPoint=function(t){var e,i,n;for(e=0,i=this.houseVO.pointList.length;i>e;e++)if(n=this.houseVO.pointList[e],Math.abs(t.x-n.x)<this.overSize&&Math.abs(t.y-n.y)<this.overSize)return n;return null},s.onTouch=function(t){null==this._overPoint?(this._downPos.x=t.stageX,this._downPos.y=t.stageY,this._curPos.x=this._downPos.x,this._curPos.y=this._downPos.y,this._fsm.switchTo(this.STATE_MOVE)):(this._startDragPoint.x=this._overPoint.x,this._startDragPoint.y=this._overPoint.y,this._fsm.switchTo(this.STATE_DRAG_POINT))},s.onTouchEnd=function(t){this._stage.removeEventListener(egret.TouchEvent.TOUCH_MOVE,this.onTouchMove,this),this._stage.removeEventListener(egret.TouchEvent.TOUCH_END,this.onTouchEnd,this),this._fsm.switchTo(this.STATE_NOMAL)},s.onTouchMove=function(t){var e=t.stageX,i=t.stageY;
this._deltaPos.x=e-this._curPos.x,this._deltaPos.y=i-this._curPos.y,this._curPos.x=e,this._curPos.y=i,this.send(ViewNotification.MOVE,this._posArr)},s.onDragMove=function(t){this._cursorPos.x=t.stageX,this._cursorPos.y=t.stageY,this.globalToWallView(this._cursorPos,this._viewMousePos),this._overPoint.x=this._viewMousePos.x,this._overPoint.y=this._viewMousePos.y,this.send(ViewNotification.UPDATE_WALL_POINT,this._overPoint)},s.onDragEnd=function(t){if(this._fsm.switchTo(this.STATE_NOMAL),this._overPoint&&(this._overPoint.x!=this._startDragPoint.x||this._overPoint.y!=this._startDragPoint.y)){var e={};e.oldX=this._startDragPoint.x,e.oldY=this._startDragPoint.y,e.newX=this._overPoint.x,e.newY=this._overPoint.y,e.point=this._overPoint,this.sendCommand(CommandNotification.MODIFY_POINT,e)}},s.globalToWallView=function(t,e){e.x=t.x-this.wallView.x,e.y=t.y-this.wallView.y},i(s,"wallView",function(){return ControlManager.instance.mainViewControl.view.wallView}),i(s,"houseVO",function(){return ControlManager.instance.mainViewControl.houseVO}),e}(BaseControl);egret.registerClass(SceneControl,"SceneControl");var WallViewControl=function(t){function e(e,i,n){t.call(this),this._wallView=e,this._wallPointView=i,this._houseVO=n}__extends(e,t);var i=(__define,e),n=i.prototype;return n.initListener=function(){this.on(ViewNotification.ADD_HELP_ROOM,this.onAddHelpRoom),this.on(ViewNotification.REFRESH_HELP_ROOM,this.onRefreshHelpRoom),this.on(ViewNotification.ADD_HELP_LINE,this.onAddHelpLine),this.on(ViewNotification.REFRESH_HELP_LINE,this.onRefreshHelpLine),this.on(ViewNotification.OVER_POINTVO,this.onOverPointVO),this.on(ViewNotification.OUT_POINTVO,this.onOutPointVO),this.on(ViewNotification.UPDATE_WALL_POINT,this.onUpdateWallPoint)},n.removeListener=function(){this.off(ViewNotification.ADD_HELP_ROOM,this.onAddHelpRoom),this.off(ViewNotification.REFRESH_HELP_ROOM,this.onRefreshHelpRoom),this.off(ViewNotification.ADD_HELP_LINE,this.onAddHelpLine),this.off(ViewNotification.REFRESH_HELP_LINE,this.onRefreshHelpLine),this.off(ViewNotification.OVER_POINTVO,this.onOverPointVO),this.off(ViewNotification.OUT_POINTVO,this.onOutPointVO)},n.onAddHelpRoom=function(t){this.addHelpRectRoom(t.data)},n.onRefreshHelpRoom=function(){this.refreshHelpRectRoom()},n.onAddHelpLine=function(t){this.addHelpLine(t.data)},n.onRefreshHelpLine=function(){this.refreshHelpLine()},n.onOverPointVO=function(t){this._wallPointView.setOver(t.data)},n.onOutPointVO=function(t){this._wallPointView.setOut(t.data)},n.onUpdateWallPoint=function(t){t.data;this.refresh()},n.refresh=function(){this._wallView.wallList=this._houseVO.wallList,this._wallPointView.pointList=this._houseVO.pointList},n.checkRectRoomWall1=function(t){var e,i;for(e=0,i=t.lineList.length;i>e;++e)this.getWallVO(t.lineList[e])},n.addHelpRectRoom=function(t){var e,i,n=[];for(e=0,i=t.lineList.length;i>e;++e){var s=new WallVO(t.lineList[e].p0,t.lineList[e].p1);n.push(s)}this._helpWallList=n,this._wallView.helpWallList=n},n.refreshHelpRectRoom=function(){this._wallView.helpWallList=this._helpWallList},n.addHelpLine=function(t){var e=[],i=new WallVO(t.p0,t.p1);e.push(i),this._helpWallList=e,this._wallView.helpWallList=e},n.refreshHelpLine=function(){this._wallView.helpWallList=this._helpWallList},n.addRectRoom=function(t){var e,i,n,s,o;for(e=0,i=t.lineList.length;i>e;++e)for(this._houseVO.addLine(t.lineList[e]),o=t.lineList[e].walls,n=0,s=o.length;s>n;++n)this._houseVO.addWall(o[n]);this._wallView.wallList=this._houseVO.wallList},n.removeRectRoom=function(t){var e,i,n,s,o;for(e=0,i=t.lineList.length;i>e;++e)for(this._houseVO.removeLine(t.lineList[e]),o=t.lineList[e].walls,n=0,s=o.length;s>n;++n)this._houseVO.removeWall(o[n]);this._wallView.wallList=this._houseVO.wallList},n.getWallVO=function(t){var e=[],i=new WallVO(t.p0,t.p1);return e.push(i),t.walls=e,e},n.checkAddLine=function(t){var e,i,n,s,o,r,a=[],h=[],l=[],a=[],_={};for(e=0,i=this._houseVO.wallList.length;i>e;++e)if(n=this._houseVO.wallList[e],t.p0.x==n.p0.x&&t.p0.y==n.p0.y&&t.p1.x==n.p1.x&&t.p1.y==n.p1.y||t.p1.x==n.p0.x&&t.p1.y==n.p0.y&&t.p0.x==n.p1.x&&t.p0.y==n.p1.y)return null;for(e=0,i=this._houseVO.wallList.length;i>e;++e)if(n=this._houseVO.wallList[e],r=DMath.segmentsIntr(n.p0,n.p1,t.p0,t.p1),r&&r.length>0){if(1==r.length)s=r[0],o=this._houseVO.getPointValue(s.x,s.y),null==o&&(o=new PointVO(s.x,s.y));else{if(2!=r.length)return null;if(null!=r[0]){if(t.p0==r[0]&&t.p1==r[1]||t.p1==r[0]&&t.p0==r[1]){for(h.length=0,h.push(n.p0),h.push(t.p0),h.push(t.p1),h.push(n.p1),l.length=0,l.push(n),a.length=0,h.sort(this.sortPoint),e=1,i=h.length;i>e;++e)if(h[e-1].x==h[e].x&&h[e-1].y==h[e].y);else{var u=new WallVO(h[e-1],h[e]);a.push(u)}return _.addWalls=a,_.delWalls=l,_}if(n.p0==r[0]&&n.p1==r[1]||n.p1==r[0]&&n.p0==r[1]){for(h.length=0,h.push(t.p0),h.push(n.p0),h.push(n.p1),h.push(t.p1),l.length=0,a.length=0,h.sort(this.sortPoint),e=1,i=h.length;i>e;++e)if(h[e-1].x==h[e].x&&h[e-1].y==h[e].y);else{var u=new WallVO(h[e-1],h[e]);a.push(u)}return 3==a.length&&a.splice(1,1),_.addWalls=a,_.delWalls=l,_}for(h.length=0,h.push(n.p0),h.push(t.p0),h.push(t.p1),h.push(n.p1),l.length=0,l.push(n),a.length=0,h.sort(this.sortPoint),e=1,i=h.length;i>e;++e)if(h[e-1].x==h[e].x&&h[e-1].y==h[e].y);else{var u=new WallVO(h[e-1],h[e]);a.push(u)}return _.addWalls=a,_.delWalls=l,_}s=r[1],o=s}if(h.push(o),o==n.p0||o==n.p1);else{l.push(n);var c=new WallVO(n.p0,o),d=new WallVO(o,n.p1);a.push(c,d)}}for(o=this._houseVO.getPointValue(t.p0.x,t.p0.y),null==o&&(o=t.p0),h.push(o),o=this._houseVO.getPointValue(t.p1.x,t.p1.y),null==o&&(o=t.p1),h.push(o),h.sort(this.sortPoint),e=1,i=h.length;i>e;++e)if(h[e-1].x==h[e].x&&h[e-1].y==h[e].y);else{var u=new WallVO(h[e-1],h[e]);a.push(u)}return _.addWalls=a,_.delWalls=l,_},n.checkRectRoomWall=function(t){var e,i,n,s,o=[],r=[];for(e=0,i=t.lineList.length;i>e;++e)n=t.lineList[e],s=this.checkAddLine(n),null!=s&&(o=o.concat(s.addWalls),r=r.concat(s.delWalls));if(0==o.length&&0==r.length)return null;var a={};return a.addWalls=o,a.delWalls=r,a},n.sortPoint=function(t,e){return t.x<e.x?-1:t.x>e.x?1:t.y<e.y?-1:1},e}(BaseControl);egret.registerClass(WallViewControl,"WallViewControl");var LoadingUI=function(t){function e(){t.call(this),this.createView()}__extends(e,t);var i=(__define,e),n=i.prototype;return n.createView=function(){this.textField=new egret.TextField,this.addChild(this.textField),this.textField.y=300,this.textField.width=480,this.textField.height=100,this.textField.textAlign="center"},n.setProgress=function(t,e){this.textField.text="Loading..."+t+"/"+e},e}(egret.Sprite);egret.registerClass(LoadingUI,"LoadingUI");var Main=function(t){function e(){t.apply(this,arguments),this.isThemeLoadEnd=!1,this.isResourceLoadEnd=!1}__extends(e,t);var i=(__define,e),n=i.prototype;return n.createChildren=function(){t.prototype.createChildren.call(this);var e=new AssetAdapter;this.stage.registerImplementation("eui.IAssetAdapter",e),this.stage.registerImplementation("eui.IThemeAdapter",new ThemeAdapter),this.loadingView=new LoadingUI,this.stage.addChild(this.loadingView),RES.addEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this),RES.loadConfig("resource/default.res.json","resource/")},n.onConfigComplete=function(t){RES.removeEventListener(RES.ResourceEvent.CONFIG_COMPLETE,this.onConfigComplete,this);var e=new eui.Theme("resource/default.thm.json",this.stage);e.addEventListener(eui.UIEvent.COMPLETE,this.onThemeLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.addEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.addEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),RES.loadGroup("preload")},n.onThemeLoadComplete=function(){this.isThemeLoadEnd=!0,this.createScene()},n.onResourceLoadComplete=function(t){"preload"==t.groupName&&(this.stage.removeChild(this.loadingView),RES.removeEventListener(RES.ResourceEvent.GROUP_COMPLETE,this.onResourceLoadComplete,this),RES.removeEventListener(RES.ResourceEvent.GROUP_LOAD_ERROR,this.onResourceLoadError,this),RES.removeEventListener(RES.ResourceEvent.GROUP_PROGRESS,this.onResourceProgress,this),RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,this.onItemLoadError,this),this.isResourceLoadEnd=!0,this.createScene())},n.createScene=function(){this.isThemeLoadEnd&&this.isResourceLoadEnd&&this.createView()},n.onItemLoadError=function(t){console.warn("Url:"+t.resItem.url+" has failed to load")},n.onResourceLoadError=function(t){console.warn("Group:"+t.groupName+" has failed to load"),this.onResourceLoadComplete(t)},n.onResourceProgress=function(t){"preload"==t.groupName&&this.loadingView.setProgress(t.itemsLoaded,t.itemsTotal)},n.startCreateScene=function(){var t=new eui.Button;t.label="Click!",t.horizontalCenter=0,t.verticalCenter=0,this.addChild(t),t.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this)},n.onButtonClick=function(t){var e=new eui.Panel;e.title="Title",e.horizontalCenter=0,e.verticalCenter=0,this.addChild(e)},n.createView=function(){var t=new MainView;this.addChild(t),SignBus.appStage=this.stage,mouse.enable(this.stage),mouse.setMouseMoveEnabled(!0),ControlManager.instance.mainViewControl.view=t},e}(eui.UILayer);egret.registerClass(Main,"Main");var ConstColor=function(){function t(){}var e=(__define,t);e.prototype;return t.WALL_COLOR=16777215,t.POINT_COLOR=16711680,t.OVER_POINT_COLOR=16776960,t}();egret.registerClass(ConstColor,"ConstColor");var ConstVO=function(){function t(){}var e=(__define,t);e.prototype;return t.PIXEL_METER=100,t.DEFAULT_WALL_THICKNESS=.12,t.WALL_THCKNESS=[.37,.3,.24,.2,.18,.12,.1],t}();egret.registerClass(ConstVO,"ConstVO");var HouseVO=function(){function t(){this.lineList=[],this.pointList=[],this.wallList=[]}var e=(__define,t),i=e.prototype;return i.addLine=function(t){-1==this.lineList.indexOf(t)&&this.lineList.push(t)},i.removeLine=function(t){var e=this.lineList.indexOf(t);e>=0&&this.lineList.splice(e,1)},i.addPoint=function(t){-1==this.pointList.indexOf(t)&&this.pointList.push(t)},i.removePoint=function(t){var e=this.pointList.indexOf(t);e>=0&&this.pointList.splice(e,1)},i.addWall=function(t){-1==this.wallList.indexOf(t)&&(this.wallList.push(t),this.addPoint(t.p0),this.addPoint(t.p1))},i.removeWall=function(t){var e,i=this.wallList.indexOf(t);i>=0&&(this.wallList.splice(i,1),e=this.getPointWallNum(t.p0),0>=e&&this.removePoint(t.p0),e=this.getPointWallNum(t.p1),0>=e&&this.removePoint(t.p1))},i.getPointWallNum=function(t){var e,i,n=0;for(e=0,i=this.wallList.length;i>e;++e)(this.wallList[e].p0==t||this.wallList[e].p1==t)&&++n;return n},i.getPointValue=function(t,e){var i,n;for(i=0,n=this.pointList.length;n>i;++i)if(this.pointList[i].x==t&&this.pointList[i].y==e)return this.pointList[i];return null},t}();egret.registerClass(HouseVO,"HouseVO");var LineVO=function(){function t(t,e){void 0===t&&(t=null),void 0===e&&(e=null),this.thickness=ConstVO.DEFAULT_WALL_THICKNESS,this.p0=t,this.p1=e}var e=__define,i=t,n=i.prototype;return e(n,"tg",function(){var t=this.p0.x-this.p1.x,e=this.p0.y-this.p1.y;return 0!=e?t/e:Number.MAX_VALUE}),t}();egret.registerClass(LineVO,"LineVO");var PointVO=function(t){function e(e,i){void 0===e&&(e=0),void 0===i&&(i=0),t.call(this,e,i)}__extends(e,t);var i=(__define,e);i.prototype;return e}(egret.Point);egret.registerClass(PointVO,"PointVO");var RectRoomVO=function(){function t(t,e){this._lineList=[],this.leftTop=new PointVO(t.x,t.y),this.rightBottom=new PointVO(e.x,e.y),this.leftBottom=new PointVO(t.x,e.y),this.rightTop=new PointVO(e.x,t.y),this.topWall=new LineVO(this.leftTop,this.rightTop),this.bottomWall=new LineVO(this.leftBottom,this.rightBottom),this.leftWall=new LineVO(this.leftTop,this.leftBottom),this.rightWall=new LineVO(this.rightTop,this.rightBottom),this._lineList.push(this.topWall),this._lineList.push(this.bottomWall),this._lineList.push(this.leftWall),this._lineList.push(this.rightWall)}var e=__define,i=t,n=i.prototype;return n.reSize=function(t,e){this.leftTop.x=t.x,this.leftTop.y=t.y,this.rightBottom.x=e.x,this.rightBottom.y=e.y,this.leftBottom.x=t.x,this.leftBottom.y=e.y,this.rightTop.x=e.x,this.rightTop.y=t.y},e(n,"lineList",function(){return this._lineList}),t}();egret.registerClass(RectRoomVO,"RectRoomVO");var RoomVO=function(){function t(){}var e=(__define,t);e.prototype;return t}();egret.registerClass(RoomVO,"RoomVO");var WallVO=function(){function t(e,i){this.p0=e,this.p1=i,this._id=t.num++}var e=(__define,t);e.prototype;return t.num=0,t}();egret.registerClass(WallVO,"WallVO");var ThemeAdapter=function(){function t(){}var e=(__define,t),i=e.prototype;return i.getTheme=function(t,e,i,n){function s(t){e.call(n,t)}function o(e){e.resItem.url==t&&(RES.removeEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),i.call(n))}RES.addEventListener(RES.ResourceEvent.ITEM_LOAD_ERROR,o,null),RES.getResByUrl(t,s,this,RES.ResourceItem.TYPE_TEXT)},t}();egret.registerClass(ThemeAdapter,"ThemeAdapter",["eui.IThemeAdapter"]);var Cursor=function(){function t(){}var e=__define,i=t;i.prototype;return t.init=function(e){t.canvas=e},e(t,"layer",void 0,function(e){t.cursorLayer=e}),t.setCursor=function(e){switch(t.removeCursor(),t.curCursor=null,e){case t.AUTO:t.canvas.style.cursor=e;break;case t.HAND:t.canvas.style.cursor=e;break;case t.CROSS:t.curCursor=CursorCross.instance,t.addCursor();break;default:t.canvas.style.cursor=t.AUTO}},t.addCursor=function(){t.curCursor&&t.cursorLayer&&t.cursorLayer.addChild(t.curCursor)},t.removeCursor=function(){t.curCursor&&t.curCursor.parent&&t.cursorLayer.removeChild(t.curCursor)},e(t,"x",void 0,function(e){t._x=e,t.curCursor&&(t.curCursor.x=t._x)}),e(t,"y",void 0,function(e){t._y=e,t.curCursor&&(t.curCursor.y=t._y)}),t.AUTO="auto",t.HAND="pointer",t.CROSS="cross",t}();egret.registerClass(Cursor,"Cursor");var CursorCross=function(t){function e(){t.call(this),this._size=10,this.graphics.clear(),this.graphics.lineStyle(1,16711680),this.graphics.moveTo(-this._size,0),this.graphics.lineTo(this._size,0),this.graphics.moveTo(0,-this._size),this.graphics.lineTo(0,this._size)}__extends(e,t);var i=__define,n=e;n.prototype;return i(e,"instance",function(){return null==e._instance&&(e._instance=new e),e._instance}),e}(egret.Sprite);egret.registerClass(CursorCross,"CursorCross");var DrawToolBar=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},n.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e}(eui.Component);egret.registerClass(DrawToolBar,"DrawToolBar",["eui.UIComponent"]);var MainToolBar=function(t){function e(){t.call(this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.partAdded=function(e,i){t.prototype.partAdded.call(this,e,i)},n.childrenCreated=function(){t.prototype.childrenCreated.call(this)},e}(eui.Component);egret.registerClass(MainToolBar,"MainToolBar",["eui.UIComponent"]);var GridBackgroud=function(t){function e(){t.call(this),this.LINE_COLOE=13421772,this._size=25,this._posX=0,this._posY=0}__extends(e,t);var i=(__define,e),n=i.prototype;return n.setSize=function(t,e){(this._width!=t||this._height!=e)&&(this._width=t,this._height=e,this._invalide=!0,this.draw())},n.draw=function(){if(this._invalide){this._invalide=!1;var t,e,i=Math.ceil(this._width/this._size),n=Math.ceil(this._height/this._size);for(this.graphics.lineStyle(1,this.LINE_COLOE),t=-2;i+2>t;++t)this.graphics.moveTo(t*this._size,-2*this._size),this.graphics.lineTo(t*this._size,this._height+2*this._size);for(e=-2;n+2>e;++e)this.graphics.moveTo(-2*this._size,e*this._size),this.graphics.lineTo(this._width+2*this._size,e*this._size)}},n.setPosition=function(t,e){(this._posX!=t||this._posY!=e)&&(this._posX=t,this._posY=e,this._deltaX=this._posX%this._size,this._deltaY=this._posY%this._size,this.x=this._deltaX,this.y=this._deltaY)},n.moveDelta=function(t,e){var i=this._posX+t,n=this._posY+e;this.setPosition(i,n)},e}(egret.Shape);egret.registerClass(GridBackgroud,"GridBackgroud");var MainView=function(t){function e(){t.call(this),this.grid=new GridBackgroud,this.addChild(this.grid),this.wallView=new WallView,this.addChild(this.wallView),this.wallPointView=new WallPointView,this.addChild(this.wallPointView),this.mainToolBar=new MainToolBar,this.mainToolBar.x=50,this.addChild(this.mainToolBar),this.drawToolBar=new DrawToolBar,this.drawToolBar.y=50,this.addChild(this.drawToolBar),this.cursorLayer=new egret.DisplayObjectContainer,this.addChild(this.cursorLayer),Cursor.layer=this.cursorLayer,this.addEventListener(egret.Event.ADDED_TO_STAGE,this.onAdded,this)}__extends(e,t);var i=(__define,e),n=i.prototype;return n.onAdded=function(t){this.init()},n.init=function(){this.onResize(),this.initListener()},n.initListener=function(){this.stage.addEventListener(egret.Event.RESIZE,this.onResize,this)},n.onResize=function(){this.mainToolBar.x=(this.stage.stageWidth-this.mainToolBar.width)/2,this.grid.setSize(this.stage.stageWidth,this.stage.stageHeight)},e}(egret.DisplayObjectContainer);egret.registerClass(MainView,"MainView");var WallComponent=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e,s=n.prototype;return i(s,"wallVO",void 0,function(t){this._wallVO=t,this.refresh()}),s.refresh=function(){this.graphics.clear(),this.graphics.lineStyle(2,ConstColor.WALL_COLOR),this.graphics.moveTo(this._wallVO.p0.x,this._wallVO.p0.y),this.graphics.lineTo(this._wallVO.p1.x,this._wallVO.p1.y)},e}(egret.Sprite);egret.registerClass(WallComponent,"WallComponent");var WallPointView=function(t){function e(){t.call(this)}__extends(e,t);var i=__define,n=e,s=n.prototype;return i(s,"pointList",void 0,function(t){this._pointList=t,this.refresh()}),s.setOver=function(t){this.graphics.beginFill(ConstColor.OVER_POINT_COLOR),this.graphics.drawCircle(t.x,t.y,e.size)},s.setOut=function(t){this.graphics.beginFill(ConstColor.POINT_COLOR),this.graphics.drawCircle(t.x,t.y,e.size)},s.refresh=function(){this.graphics.clear();var t,i,n;for(this.graphics.beginFill(ConstColor.POINT_COLOR),t=0,i=this._pointList.length;i>t;++t)n=this._pointList[t],this.graphics.drawCircle(n.x,n.y,e.size);this.graphics.endFill()},e.size=5,e}(egret.Sprite);egret.registerClass(WallPointView,"WallPointView");var WallView=function(t){function e(){t.call(this),this._wallPool=[],this._helpWallContainer=new egret.Sprite}__extends(e,t);var i=__define,n=e,s=n.prototype;return i(s,"wallList",void 0,function(t){this._wallList=t,this.refresh()}),i(s,"helpWallList",void 0,function(t){this._helpWallList=t,this.refreshHelpWall()}),s.refresh=function(){var t,e;for(this.disposeAllWallComponent(),t=0,e=this._wallList.length;e>t;++t){var i=this.getWallComponent();i.wallVO=this._wallList[t],this.addChild(i)}},s.refreshHelpWall=function(){var t,e;for(this.disposeHelpWallComponent(),t=0,e=this._helpWallList.length;e>t;++t){var i=this.getWallComponent();i.wallVO=this._helpWallList[t],this._helpWallContainer.addChild(i)}this.addChild(this._helpWallContainer)},s.getWallComponent=function(){return this._wallPool.length>0?this._wallPool.pop():new WallComponent},s.disposeAllWallComponent=function(){var t,e,i;for(t=0,e=this.numChildren;e>t;t++)i=this.getChildAt(t),egret.is(i,"WallComponent")&&-1==this._wallPool.indexOf(i)&&this._wallPool.push(i);this.removeChildren(),this.disposeHelpWallComponent()},s.disposeHelpWallComponent=function(){var t,e,i;for(t=0,e=this._helpWallContainer.numChildren;e>t;t++)i=this._helpWallContainer.getChildAt(t),egret.is(i,"WallComponent")&&-1==this._wallPool.indexOf(i)&&this._wallPool.push(i);this._helpWallContainer.removeChildren()},e}(egret.Sprite);egret.registerClass(WallView,"WallView");